<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Report Pro | Professional Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase state
        window.fb = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, onSnapshot };
    </script>

    <style>
        body { 
            font-family: Arial, Helvetica, sans-serif; 
            letter-spacing: -0.01em; 
            background-color: #CBD5E1; 
        }
        .font-arial-black {
            font-family: "Arial Black", Gadget, sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes status-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-status-icon svg {
            animation: status-pulse 2s infinite ease-in-out;
        }

        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .report-paper { border: none !important; box-shadow: none !important; width: 100% !important; margin: 0 !important; }
        }

        table { border-collapse: collapse; width: 100%; table-layout: auto; border: 1px solid #1e3a8a33; }
        th, td { border: 1px solid #1e3a8a33; word-wrap: break-word; line-height: 1.1; }
        
        .report-box {
            border: 1px solid #94a3b8; 
            background-color: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .font-bold { font-weight: 700; }
        .compact-header { padding-top: 0.4rem; padding-bottom: 0.4rem; }
        .row-compact td { padding-top: 0.15rem; padding-bottom: 0.15rem; }

        .filter-select {
            background-color: #eff6ff; 
            border: 2px solid #1d4ed8; 
            border-radius: 0.375rem;
            padding: 0.15rem 1.5rem 0.15rem 0.5rem;
            font-size: 9px;
            font-weight: 800;
            color: #1d4ed8; 
            text-transform: uppercase;
            outline: none;
            cursor: pointer;
            min-width: 130px;
            transition: all 0.2s;
        }
        .filter-select:focus { 
            border-color: #1e40af;
            box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.1);
        }
    </style>
</head>
<body class="text-slate-900 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-400 px-6 compact-header flex justify-between items-center shadow-sm shrink-0 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-blue-700 p-1.5 rounded-lg text-white shadow-md">
                <i data-lucide="ship" class="w-4 h-4"></i>
            </div>
            <div>
                <h1 class="text-md font-bold text-slate-800 tracking-tight uppercase">Logistics Pro</h1>
                <p class="text-[8px] font-bold text-blue-600 uppercase tracking-widest leading-none">Precision Tracking (Online Sync Enabled)</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div id="cloudStatus" class="text-[9px] font-bold text-slate-400 px-2 flex items-center gap-1">
                <span id="cloudIndicator" class="w-2 h-2 rounded-full bg-slate-300"></span>
                <span id="cloudLabel">Connecting...</span>
            </div>
            <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-sm">
                <i data-lucide="refresh-cw" class="w-3 h-3" id="refreshIcon"></i>
                REFRESH
            </button>
            <div id="upload-section">
                <label class="bg-slate-900 hover:bg-black text-white px-3 py-1.5 rounded-md font-bold text-[10px] cursor-pointer transition-all flex items-center gap-1.5 shadow-sm">
                    <i data-lucide="plus" class="w-3 h-3"></i>
                    UPLOAD
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
            <button id="downloadBtn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-md font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-sm">
                <i data-lucide="download" class="w-3 h-3"></i>
                EXPORT
            </button>
            <button id="resetBtn" class="hidden text-slate-500 hover:text-red-500 font-bold text-[10px] px-2">Reset</button>
        </div>
    </header>

    <main id="mainContent" class="flex-1 flex overflow-hidden">
        <aside class="w-60 bg-white border-r border-slate-400 flex flex-col shrink-0 no-print" id="sidebarContainer">
            <div class="p-3 border-b border-slate-200">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400"></i>
                    <input type="text" id="shipperSearch" placeholder="Filter shippers..." class="w-full pl-8 pr-3 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-[10px] font-bold outline-none focus:ring-1 focus:ring-blue-500/20">
                </div>
            </div>
            <div id="shipperList" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1"></div>
        </aside>

        <section class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4 print:p-0">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center p-12 bg-white rounded-2xl border border-slate-400 shadow-lg no-print mx-auto max-w-lg mt-20">
                <i data-lucide="file-spreadsheet" class="w-12 h-12 text-slate-300 mb-3"></i>
                <h2 class="text-lg font-bold text-slate-800 uppercase tracking-tight">System Ready</h2>
                <p class="text-slate-500 text-xs font-bold">Please upload a file or wait for cloud sync.</p>
            </div>

            <div id="reportContainer" class="hidden space-y-5 max-w-[1300px] mx-auto">
                <div id="overallStats" class="grid grid-cols-4 gap-3 no-print font-arial-black text-center"></div>

                <div class="report-box print:border-none print:shadow-none">
                    <div class="px-5 py-2 bg-white border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full">
                            <h2 id="activeShipperName" class="text-sm font-bold text-slate-900 tracking-tight uppercase shrink-0"></h2>
                            <div class="flex items-center gap-4 no-print">
                                <div class="flex items-center gap-2">
                                    <label class="text-[9px] font-extrabold text-blue-700 uppercase tracking-tight">Vessel Wise:</label>
                                    <select id="vesselFilter" class="filter-select" onchange="applyFilters()">
                                        <option value="ALL">All Vessels</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-[9px] font-extrabold text-blue-700 uppercase tracking-tight">BL Wise:</label>
                                    <select id="blFilter" class="filter-select" onchange="applyFilters()">
                                        <option value="ALL">All BLs</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <span id="currentTime" class="text-[9px] font-bold text-slate-500 uppercase shrink-0"></span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-[10px]">
                            <thead>
                                <tr class="bg-slate-900 text-white font-bold uppercase tracking-wider">
                                    <th class="px-2 py-1.5">BL NO</th>
                                    <th class="px-2 py-1.5 w-20">LINE</th>
                                    <th class="px-2 py-1.5">Disch_Vsl_Name</th>
                                    <th class="px-2 py-1.5 text-center w-28 uppercase">Handover Date</th>
                                    <th class="px-1.5 py-1.5 text-center bg-slate-800 w-10">20</th>
                                    <th class="px-1.5 py-1.5 text-center bg-slate-800 w-10">40</th>
                                    <th class="px-1.5 py-1.5 text-center bg-emerald-700 w-24 whitespace-normal uppercase">Railout Done</th>
                                    <th class="px-1.5 py-1.5 text-center bg-blue-600 w-20 whitespace-normal uppercase">Arrived</th>
                                    <th class="px-1.5 py-1.5 text-center bg-rose-700 w-24 whitespace-normal uppercase">Pending Containers</th>
                                </tr>
                            </thead>
                            <tbody id="reportRows" class="font-bold text-slate-700 row-compact"></tbody>
                            <tfoot id="reportFooter" class="bg-slate-100 font-bold text-slate-900 border-t border-slate-300"></tfoot>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-5 pb-10">
                    <div id="railedBreakdownContainer" class="report-box">
                        <div class="bg-emerald-600 px-4 py-1.5 flex justify-between items-center">
                            <div class="flex items-center gap-2 text-white animate-status-icon">
                                <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                                <h3 class="font-bold uppercase tracking-widest text-[9px]">Railed Out Shipments</h3>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-[9px]">
                                <thead class="bg-emerald-50 text-emerald-900 font-bold uppercase">
                                    <tr>
                                        <th class="px-3 py-1">BL (Containers/Line)</th>
                                        <th class="px-3 py-1 text-center w-24 whitespace-normal uppercase">Railout Done</th>
                                        <th class="px-3 py-1">Train No / Rake</th>
                                        <th class="px-3 py-1 text-center w-28">Railout Date</th>
                                        <th class="px-3 py-1 uppercase">Current Train Location and ETA</th>
                                    </tr>
                                </thead>
                                <tbody id="railedDetailRows" class="font-bold text-slate-600 row-compact"></tbody>
                                <tfoot id="railedDetailFooter" class="bg-emerald-50 text-emerald-900 font-bold uppercase border-t border-emerald-200"></tfoot>
                            </table>
                        </div>
                    </div>

                    <div id="pendingBreakdownContainer" class="report-box">
                        <div class="bg-rose-600 px-4 py-1.5 flex justify-between items-center text-white">
                            <div class="flex items-center gap-2 animate-status-icon">
                                <i data-lucide="clock" class="w-3.5 h-3.5"></i>
                                <h3 class="font-bold uppercase tracking-widest text-[9px]">Pending Shipments</h3>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-[9px]">
                                <thead class="bg-rose-50 text-rose-900 font-bold uppercase">
                                    <tr>
                                        <th class="px-3 py-1">BL (Containers/Line)</th>
                                        <th class="px-3 py-1">Remarks (SMTP B)</th>
                                        <th class="px-3 py-1 text-center w-24">PENDING</th>
                                        <th class="px-3 py-1 uppercase">Vessel</th>
                                        <th class="px-3 py-1 text-center w-28 uppercase">Handover Date</th>
                                        <th class="px-3 py-1 uppercase">Current Status</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingDetailRows" class="font-bold text-slate-600 row-compact"></tbody>
                                <tfoot id="pendingDetailFooter" class="bg-rose-50 text-rose-900 font-bold uppercase border-t border-rose-200"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        // ==========================================
        // Firebase Configuration
        // ==========================================
        const MY_CUSTOM_CONFIG = {
            apiKey: "AIzaSyBo1ZvNlwQN_s3k7XmyaD_-q0ikydEijFs",
            authDomain: "logistic-c6a6a.firebaseapp.com",
            projectId: "logistic-c6a6a",
            storageBucket: "logistic-c6a6a.firebasestorage.app",
            messagingSenderId: "270575499830",
            appId: "1:270575499830:web:cc280133d6cdde224b7697",
            measurementId: "G-YQ30N12NF7"
        };

        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, onSnapshot } = window.fb;
        
        let db, auth, appId;
        let isCloudEnabled = false;
        let isCustomConfigUsed = false;

        const cloudIndicator = document.getElementById('cloudIndicator');
        const cloudLabel = document.getElementById('cloudLabel');
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIcon = document.getElementById('refreshIcon');

        // Setup Logic
        if (MY_CUSTOM_CONFIG.apiKey !== "") {
            const app = initializeApp(MY_CUSTOM_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = "logistic-c6a6a-dashboard";
            isCloudEnabled = true;
            isCustomConfigUsed = true;
        } else if (typeof __firebase_config !== 'undefined') {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'logistics-pro-report';
            isCloudEnabled = true;
        } else {
            cloudLabel.innerText = "Offline Mode";
            cloudIndicator.className = "w-2 h-2 rounded-full bg-orange-400";
        }

        let rawSheets = { shipper: [], smtp: [], website: [] };
        let selectedShipper = null;
        let trainDateRemarksMap = {}; 
        let currentShipperAllGroups = []; 

        lucide.createIcons();

        // UI element references
        const fileInput = document.getElementById('fileInput');
        const emptyState = document.getElementById('emptyState');
        const reportContainer = document.getElementById('reportContainer');
        const shipperList = document.getElementById('shipperList');
        const reportRows = document.getElementById('reportRows');
        const railedDetailRows = document.getElementById('railedDetailRows');
        const railedDetailFooter = document.getElementById('railedDetailFooter');
        const pendingDetailRows = document.getElementById('pendingDetailRows');
        const pendingDetailFooter = document.getElementById('pendingDetailFooter');
        const railedBreakdownContainer = document.getElementById('railedBreakdownContainer');
        const pendingBreakdownContainer = document.getElementById('pendingBreakdownContainer');
        const reportFooter = document.getElementById('reportFooter');
        const activeShipperName = document.getElementById('activeShipperName');
        const overallStats = document.getElementById('overallStats');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const shipperSearch = document.getElementById('shipperSearch');
        const currentTime = document.getElementById('currentTime');
        const vesselFilter = document.getElementById('vesselFilter');
        const blFilter = document.getElementById('blFilter');

        currentTime.innerText = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

        // Authentication logic
        async function initAuth() {
            if (!isCloudEnabled) return;
            try {
                if (isCustomConfigUsed) {
                    await signInAnonymously(auth);
                } else if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error.code, error.message);
                cloudLabel.innerText = "Auth Error (Fix in Console)";
                cloudIndicator.className = "w-2 h-2 rounded-full bg-red-500";
            }
        }

        if (isCloudEnabled) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    cloudIndicator.className = "w-2 h-2 rounded-full bg-emerald-500";
                    cloudLabel.innerText = "Online";
                    // Initial load on login
                    loadFromCloud();
                }
            });
        }

        // Firestore storage with chunking
        async function saveToCloud() {
            if (!isCloudEnabled || !auth.currentUser) return;
            cloudLabel.innerText = "Saving...";
            cloudIndicator.classList.add('animate-pulse');
            try {
                const str = JSON.stringify(rawSheets);
                const chunkSize = 800000; 
                const chunkCount = Math.ceil(str.length / chunkSize);
                
                for (let i = 0; i < chunkCount; i++) {
                    const chunk = str.substring(i * chunkSize, (i + 1) * chunkSize);
                    const chunkRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_chunks', `chunk_${i}`);
                    await setDoc(chunkRef, { data: chunk });
                }
                
                const metaRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_meta', 'latest');
                await setDoc(metaRef, { chunkCount, updatedAt: new Date().toISOString() });
                
                cloudLabel.innerText = "Online";
                cloudIndicator.classList.remove('animate-pulse');
            } catch (e) {
                cloudLabel.innerText = "Save Error";
                console.error("Save Error:", e);
            }
        }

        async function loadFromCloud() {
            if (!isCloudEnabled || !auth.currentUser) return;
            cloudLabel.innerText = "Loading...";
            refreshIcon.classList.add('animate-spin');
            try {
                const metaRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_meta', 'latest');
                const metaSnap = await getDoc(metaRef);
                if (metaSnap.exists()) {
                    const { chunkCount } = metaSnap.data();
                    if (chunkCount === 0) {
                        cloudLabel.innerText = "Online";
                        refreshIcon.classList.remove('animate-spin');
                        return;
                    }
                    
                    let fullStr = "";
                    for (let i = 0; i < chunkCount; i++) {
                        const chunkRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_chunks', `chunk_${i}`);
                        const chunkSnap = await getDoc(chunkRef);
                        if (chunkSnap.exists()) fullStr += chunkSnap.data().data;
                    }
                    if (fullStr) {
                        rawSheets = JSON.parse(fullStr);
                        processCloudData();
                    }
                }
                cloudLabel.innerText = "Online";
            } catch (e) { 
                console.error("Cloud Load Error:", e); 
                cloudLabel.innerText = "Load Error";
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }

        function processCloudData() {
            trainDateRemarksMap = {};
            if (rawSheets.website && rawSheets.website.length > 1) {
                rawSheets.website.slice(1).forEach(row => {
                    const train = String(row[4] || '').trim(); 
                    const railDateRaw = row[8]; 
                    const railDate = String(railDateRaw || '').trim(); 
                    const remark = String(row[9] || '').trim(); 
                    if (train && railDate && remark && remark !== '-') {
                        trainDateRemarksMap[`${train}_${railDate}`] = remark;
                    }
                });
            }
            if (rawSheets.shipper && rawSheets.shipper.length) {
                initDashboard();
            }
        }

        // Business Logic for Rendering
        function formatToDDMMYYYY(val) {
            if (!val || val === '-' || val === 'N/A' || val === '') return val;
            let date;
            if (typeof val === 'number') date = new Date(Math.round((val - 25569) * 86400 * 1000));
            else date = new Date(val);
            if (isNaN(date.getTime())) return val;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const findSheet = (name) => wb.SheetNames.find(s => s.toUpperCase() === name.toUpperCase());
                rawSheets = {
                    shipper: XLSX.utils.sheet_to_json(wb.Sheets[findSheet('SHIPPER')], {header: 1}),
                    smtp: XLSX.utils.sheet_to_json(wb.Sheets[findSheet('SMTP')], {header: 1}),
                    website: XLSX.utils.sheet_to_json(wb.Sheets[findSheet('WEBSITE')], {header: 1})
                };
                if (isCloudEnabled) saveToCloud();
                processCloudData();
            };
            reader.readAsBinaryString(file);
        });

        function initDashboard() {
            emptyState.classList.add('hidden');
            reportContainer.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            downloadBtn.classList.remove('hidden');
            const headers = rawSheets.shipper[0];
            const consIndex = headers.findIndex(h => String(h).toUpperCase().includes('CONSIGNEE'));
            const uniqueShippers = [...new Set(rawSheets.shipper.slice(1).map(row => row[consIndex]))].filter(Boolean).sort();
            renderShipperList(uniqueShippers, consIndex);
            if (uniqueShippers.length > 0) window.selectShipper(uniqueShippers[0], consIndex);
        }

        function renderShipperList(shippers, consIndex) {
            const filter = shipperSearch.value.toLowerCase();
            shipperList.innerHTML = shippers
                .filter(s => String(s).toLowerCase().includes(filter))
                .map(name => `
                    <button onclick="window.selectShipper('${name.replace(/'/g, "\\'")}', ${consIndex})" class="shipper-btn w-full text-left px-3 py-2 rounded-lg text-[9px] font-bold uppercase transition-all flex items-center justify-between group ${selectedShipper === name ? 'bg-blue-700 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100'}" data-name="${name}">
                        <span class="truncate">${name}</span>
                        <i data-lucide="chevron-right" class="w-3 h-3 ${selectedShipper === name ? 'opacity-100' : 'opacity-0'}"></i>
                    </button>
                `).join('');
            lucide.createIcons();
        }

        window.selectShipper = function(name, consIndex) {
            selectedShipper = name;
            activeShipperName.innerText = name;
            vesselFilter.value = "ALL";
            blFilter.value = "ALL";
            document.querySelectorAll('.shipper-btn').forEach(btn => {
                const isActive = btn.getAttribute('data-name') === name;
                btn.className = `shipper-btn w-full text-left px-3 py-2 rounded-lg text-[9px] font-bold uppercase transition-all flex items-center justify-between group ${isActive ? 'bg-blue-700 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100'}`;
            });
            processAndRenderReport(consIndex, true); 
        };

        window.applyFilters = function() {
            if (!currentShipperAllGroups.length) return;
            let filtered = [...currentShipperAllGroups];
            const vVal = vesselFilter.value;
            const bVal = blFilter.value;
            if (vVal !== "ALL") filtered = filtered.filter(g => g.vessel === vVal);
            if (bVal !== "ALL") filtered = filtered.filter(g => g.blNo === bVal);
            renderStats(filtered);
            renderMainTable(filtered);
            renderDetailedBreakdown(filtered);
        };

        function processAndRenderReport(consIndex, shouldPopulateFilters = false) {
            const headers = rawSheets.shipper[0];
            const sizeIndex = headers.findIndex(h => String(h).toUpperCase().includes('SIZE'));
            const relevantRows = rawSheets.shipper.slice(1).filter(row => row[consIndex] === selectedShipper);
            const blGroups = {};
            const excludedTerms = ['CT3', 'CT4', 'MICT', 'SPRH', 'T2'];
            relevantRows.forEach(row => {
                const contNo = String(row[0] || '').trim(); 
                const blNo = String(row[2] || 'N/A').trim(); 
                const sizeValue = String(row[sizeIndex] || '').includes('40') ? 40 : 20;
                if (!blGroups[blNo]) {
                    blGroups[blNo] = { 
                        blNo, stats: { total: 0, s20: 0, s40: 0, railed: 0, pending: 0, r20: 0, r40: 0, p20: 0, p40: 0 },
                        line: '-', vessel: '-', handoverDt: '-', 
                        railedDetails: [], pendingRemarks: [], smtpBRemarks: [], isAnySmtp: false
                    };
                }
                const smtpRow = rawSheets.smtp.find(s => String(s[2] || '').trim() === contNo);
                const webRow = rawSheets.website.find(w => String(w[3] || '').trim() === contNo);
                const isHandover = !!smtpRow;
                const railDateRaw = webRow ? webRow[8] : '';
                const railDateStr = String(railDateRaw || '').trim();
                if (isHandover) {
                    blGroups[blNo].isAnySmtp = true;
                    if (blGroups[blNo].vessel === '-') blGroups[blNo].vessel = smtpRow[5] || '-'; 
                    if (blGroups[blNo].handoverDt === '-') blGroups[blNo].handoverDt = smtpRow[18] || smtpRow[17] || '-'; 
                    if (blGroups[blNo].line === '-') blGroups[blNo].line = smtpRow[23] || '-'; 
                    const cellBVal = String(smtpRow[1] || '').trim();
                    if (cellBVal && !excludedTerms.includes(cellBVal.toUpperCase()) && !blGroups[blNo].smtpBRemarks.includes(cellBVal)) {
                        blGroups[blNo].smtpBRemarks.push(cellBVal);
                    }
                }
                const isRailed = railDateStr && !['-', 'NOT RAILOUT', 'PENDING', '', 'N/A'].includes(railDateStr.toUpperCase());
                if (isRailed) {
                    const trainNo = String(webRow[4] || '').trim();
                    const remark = trainDateRemarksMap[`${trainNo}_${railDateStr}`] || String(webRow[9] || '-').trim();
                    const formattedRailDate = formatToDDMMYYYY(railDateRaw);
                    let existingDetail = blGroups[blNo].railedDetails.find(d => d.train === trainNo && d.date === formattedRailDate);
                    if (existingDetail) existingDetail.count++;
                    else blGroups[blNo].railedDetails.push({ train: trainNo || 'Railed', date: formattedRailDate, remark: remark, count: 1 });
                    if (sizeValue === 20) blGroups[blNo].stats.r20++; else blGroups[blNo].stats.r40++;
                } else {
                    const pRem = (webRow && webRow[9] && webRow[9] !== '-') ? webRow[9] : (smtpRow && smtpRow[22] ? smtpRow[22] : null);
                    if (pRem && !blGroups[blNo].pendingRemarks.includes(pRem)) blGroups[blNo].pendingRemarks.push(pRem);
                    if (sizeValue === 20) blGroups[blNo].stats.p20++; else blGroups[blNo].stats.p40++;
                }
                blGroups[blNo].stats.total++;
                if (sizeValue === 20) blGroups[blNo].stats.s20++; else blGroups[blNo].stats.s40++;
                if (isRailed) blGroups[blNo].stats.railed++; else blGroups[blNo].stats.pending++;
            });
            currentShipperAllGroups = Object.values(blGroups);
            if (shouldPopulateFilters) {
                const uniqueVessels = [...new Set(currentShipperAllGroups.map(g => g.vessel))].filter(v => v && v !== '-').sort();
                const uniqueBLs = currentShipperAllGroups.map(g => g.blNo).filter(Boolean).sort();
                vesselFilter.innerHTML = '<option value="ALL">All Vessels</option>' + uniqueVessels.map(v => `<option value="${v}">${v}</option>`).join('');
                blFilter.innerHTML = '<option value="ALL">All BLs</option>' + uniqueBLs.map(b => `<option value="${b}">${b}</option>`).join('');
            }
            window.applyFilters();
        }

        function renderMainTable(groups) {
            let g20 = 0, g40 = 0, gR = 0, gA = 0, gP = 0;
            reportRows.innerHTML = groups.map(bl => {
                g20 += bl.stats.s20; g40 += bl.stats.s40; gR += bl.stats.railed; gP += bl.stats.pending;
                const arrivedCount = bl.railedDetails.reduce((acc, d) => /TRAIN ARRIVED/i.test(d.remark) ? acc + d.count : acc, 0);
                gA += arrivedCount;
                const sizeLabel = `(${bl.stats.total}X${bl.stats.s40 > 0 ? '40' : '20'})`;
                const vesselDisplay = (!bl.isAnySmtp && bl.stats.railed === 0) ? '<span class="text-rose-600 font-bold italic">NOT Handover</span>' : bl.vessel;
                return `
                    <tr class="border-b border-slate-200 hover:bg-slate-50 transition-colors">
                        <td class="px-2 py-1 font-bold text-slate-900 border-r border-slate-300 truncate">${bl.blNo} <span class="text-blue-600 font-bold ml-1 text-[8px] uppercase">${sizeLabel}</span></td>
                        <td class="px-2 py-1 text-slate-600 border-r border-slate-300 font-bold uppercase truncate">${bl.line}</td>
                        <td class="px-2 py-1 text-slate-700 border-r border-slate-300 font-bold uppercase truncate">${vesselDisplay}</td>
                        <td class="px-2 py-1 text-slate-500 border-r border-slate-300 text-center font-bold uppercase text-[9px]">${bl.handoverDt}</td>
                        <td class="px-1 py-1 text-center border-r border-slate-300 bg-slate-50/50 ${bl.stats.s20 > 0 ? 'text-slate-800' : 'text-slate-200'}">${bl.stats.s20 || '-'}</td>
                        <td class="px-1 py-1 text-center border-r border-slate-300 bg-slate-50/50 ${bl.stats.s40 > 0 ? 'text-slate-800' : 'text-slate-200'}">${bl.stats.s40 || '-'}</td>
                        <td class="px-1.5 py-1 text-center border-r border-slate-300 bg-emerald-50 text-emerald-700">${bl.stats.railed || '-'}</td>
                        <td class="px-1.5 py-1 text-center border-r border-slate-300 bg-blue-50 text-blue-700">${arrivedCount || '-'}</td>
                        <td class="px-1.5 py-1 text-center border-r border-slate-300 bg-rose-50 text-rose-700">${bl.stats.pending || '-'}</td>
                    </tr>
                `;
            }).join('');
            reportFooter.innerHTML = `
                <tr class="bg-slate-100 text-slate-900">
                    <td colspan="4" class="px-2 py-1.5 text-right uppercase font-bold text-slate-500 text-[9px]">Grand Totals</td>
                    <td class="px-1 py-1.5 text-center text-xs font-bold border-r border-slate-300">${g20}</td>
                    <td class="px-1 py-1.5 text-center text-xs font-bold border-r border-slate-300">${g40}</td>
                    <td class="px-1.5 py-1.5 text-center text-xs font-bold text-emerald-700 border-r border-slate-300">${gR}</td>
                    <td class="px-1.5 py-1.5 text-center text-xs font-bold text-blue-700 border-r border-slate-300">${gA}</td>
                    <td class="px-1.5 py-1.5 text-center text-xs font-bold text-rose-700">${gP}</td>
                </tr>
            `;
        }

        function renderDetailedBreakdown(groups) {
            const railedGroups = groups.filter(g => g.stats.railed > 0);
            const pendingGroups = groups.filter(g => g.stats.pending > 0);
            let totalRailedUnits = 0, totalPendingUnits = 0;
            if (railedGroups.length === 0) railedBreakdownContainer.classList.add('hidden');
            else {
                railedBreakdownContainer.classList.remove('hidden');
                let rHtml = '';
                railedGroups.forEach(bl => {
                    bl.railedDetails.forEach((detail, idx) => {
                        totalRailedUnits += detail.count;
                        const isArrived = /TRAIN ARRIVED/i.test(detail.remark);
                        const remarkClass = isArrived ? 'bg-yellow-100 text-slate-900' : 'text-slate-500';
                        rHtml += `<tr class="border-b border-slate-200 hover:bg-emerald-50/30">`;
                        if (idx === 0) rHtml += `<td rowspan="${bl.railedDetails.length}" class="px-3 py-1 font-bold text-slate-900 border-r border-slate-300 align-top">${bl.blNo} <span class="text-blue-500 text-[8px] uppercase font-bold">(${bl.stats.total} / ${bl.line})</span></td>`;
                        rHtml += `<td class="px-3 py-1 text-center font-bold text-emerald-700 bg-emerald-50 border-r border-slate-300">${detail.count}</td><td class="px-3 py-1 text-slate-700 font-bold uppercase border-r border-slate-300">${detail.train}</td><td class="px-3 py-1 text-center text-blue-600 font-bold border-r border-slate-300 uppercase whitespace-nowrap">${detail.date}</td><td class="px-3 py-1 ${remarkClass} text-[9px] font-bold">${detail.remark}</td></tr>`;
                    });
                    rHtml += `<tr class="bg-blue-100/60 font-bold border-b border-blue-200"><td class="px-3 py-1 text-blue-800 uppercase text-[8px]">Total</td><td class="px-3 py-1 text-center text-blue-900 border-r border-blue-200">${bl.stats.railed}</td><td colspan="3"></td></tr>`;
                });
                railedDetailRows.innerHTML = rHtml;
                railedDetailFooter.innerHTML = `<tr class="bg-emerald-50 text-emerald-800 font-bold"><td class="px-3 py-1.5 text-right uppercase text-[9px]">Total Railed Units</td><td class="px-3 py-1.5 text-center text-[11px] border-r border-emerald-200">${totalRailedUnits}</td><td colspan="3"></td></tr>`;
            }
            if (pendingGroups.length === 0) pendingBreakdownContainer.classList.add('hidden');
            else {
                pendingBreakdownContainer.classList.remove('hidden');
                let pHtml = '';
                pendingGroups.forEach(bl => {
                    totalPendingUnits += bl.stats.pending;
                    const statusLabel = bl.isAnySmtp ? `<span class="text-blue-600 uppercase font-bold text-[9px]">${bl.handoverDt}</span>` : '<span class="text-rose-600 uppercase font-bold text-[9px]">Pending Handover</span>';
                    const bRem = bl.smtpBRemarks.join(' | ');
                    const isUrgent = /scan|scanning|damage/i.test(bRem);
                    pHtml += `<tr class="border-b border-slate-200 hover:bg-rose-50/30"><td class="px-3 py-1 font-bold text-slate-900 border-r border-slate-300">${bl.blNo} <span class="text-blue-500 text-[8px] uppercase font-bold">(${bl.stats.total} / ${bl.line})</span></td><td class="px-3 py-1 text-slate-600 font-bold border-r border-slate-300 text-[8px] uppercase ${isUrgent ? 'text-rose-700 font-bold' : ''}">${bRem || '-'}</td><td class="px-3 py-1 text-center font-bold text-rose-700 bg-rose-50/50 border-r border-slate-300">${bl.stats.pending}</td><td class="px-3 py-1 text-slate-700 font-bold uppercase border-r border-slate-300">${bl.vessel}</td><td class="px-3 py-1 text-center font-bold uppercase border-r border-slate-300">${statusLabel}</td><td class="px-3 py-1 text-slate-500 text-[9px] font-bold">${bl.pendingRemarks.join(' | ') || 'Awaiting dispatch'}</td></tr>`;
                });
                pendingDetailRows.innerHTML = pHtml;
                pendingDetailFooter.innerHTML = `<tr class="bg-rose-50 text-rose-800 font-bold"><td colspan="2" class="px-3 py-1.5 text-right uppercase text-[9px]">Total Pending Units</td><td class="px-3 py-1.5 text-center text-[11px] border-r border-rose-200">${totalPendingUnits}</td><td colspan="3"></td></tr>`;
            }
            lucide.createIcons();
        }

        function renderStats(groups) {
            const t20 = groups.reduce((acc, b) => acc + b.stats.s20, 0);
            const t40 = groups.reduce((acc, b) => acc + b.stats.s40, 0);
            const r20 = groups.reduce((acc, b) => acc + b.stats.r20, 0);
            const r40 = groups.reduce((acc, b) => acc + b.stats.r40, 0);
            const p20 = groups.reduce((acc, b) => acc + b.stats.p20, 0);
            const p40 = groups.reduce((acc, b) => acc + b.stats.p40, 0);
            const formatSubCount = (c20, c40, colorClass) => {
                let parts = [];
                if (c20 > 0) parts.push(`<span class="${colorClass}">(${c20} <span class="text-[8px]">x</span> 20")</span>`);
                if (c40 > 0) parts.push(`<span class="${colorClass}">(${c40} <span class="text-[8px]">x</span> 40")</span>`);
                return parts.join(' ');
            };
            const subColor = "text-blue-900 font-bold text-[12px]";
            overallStats.innerHTML = `<div class="bg-white p-2 rounded-xl border-b-4 border-b-orange-500 border border-slate-400 shadow-sm flex flex-col items-center"><span class="text-[7px] font-bold text-slate-400 uppercase tracking-widest">Total Containers</span><span class="text-lg font-bold text-slate-900">${t20 + t40}</span><div class="mt-0.5">${formatSubCount(t20, t40, subColor)}</div></div><div class="bg-emerald-50 p-2 rounded-xl border-b-4 border-b-emerald-500 border border-slate-400 shadow-sm flex flex-col items-center"><span class="text-[7px] font-bold text-emerald-600 uppercase tracking-widest">Railout Done</span><span class="text-lg font-bold text-emerald-700">${r20 + r40}</span><div class="mt-0.5">${formatSubCount(r20, r40, subColor)}</div></div><div class="bg-rose-50 p-2 rounded-xl border-b-4 border-b-rose-500 border border-slate-400 shadow-sm flex flex-col items-center"><span class="text-[7px] font-bold text-rose-600 uppercase tracking-widest">Pending</span><span class="text-lg font-bold text-rose-700">${p20 + p40}</span><div class="mt-0.5">${formatSubCount(p20, p40, subColor)}</div></div><div class="bg-white p-2 rounded-xl border-b-4 border-b-blue-600 border border-slate-400 shadow-sm flex flex-col items-center"><span class="text-[7px] font-bold text-blue-500 uppercase tracking-widest">Total B/L</span><span class="text-xl font-bold text-blue-600 mt-0.5 leading-none">${groups.length}</span></div>`;
        }

        downloadBtn.addEventListener('click', () => {
            if (!selectedShipper) return;
            let dataToExport = [...currentShipperAllGroups];
            if (vesselFilter.value !== "ALL") dataToExport = dataToExport.filter(g => g.vessel === vesselFilter.value);
            if (blFilter.value !== "ALL") dataToExport = dataToExport.filter(g => g.blNo === blFilter.value);
            const wb = XLSX.utils.book_new();
            const flat = dataToExport.map(g => ({
                'BL Number': g.blNo, 'Line': g.line, 'Vessel': g.vessel, 'Handover Date': g.handoverDt,
                '20ft': g.stats.s20, '40ft': g.stats.s40, 'Railout Done': g.stats.railed, 
                'Arrived': g.railedDetails.reduce((acc, d) => /TRAIN ARRIVED/i.test(d.remark) ? acc + d.count : acc, 0), 
                'Pending Containers': g.stats.pending
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(flat), "Summary");
            XLSX.writeFile(wb, `${selectedShipper}_Logistics.xlsx`);
        });

        refreshBtn.addEventListener('click', () => {
            if (isCloudEnabled) loadFromCloud();
        });

        resetBtn.addEventListener('click', async () => {
            if (!isCloudEnabled || !auth.currentUser) return;
            const metaRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_meta', 'latest');
            await setDoc(metaRef, { chunkCount: 0, updatedAt: new Date().toISOString() });
            location.reload();
        });

        initAuth();

        shipperSearch.addEventListener('input', () => {
            if (!rawSheets.shipper || !rawSheets.shipper.length) return;
            const consIndex = rawSheets.shipper[0].findIndex(h => String(h).toUpperCase().includes('CONSIGNEE'));
            const uniqueShippers = [...new Set(rawSheets.shipper.slice(1).map(row => row[consIndex]))].filter(Boolean).sort();
            renderShipperList(uniqueShippers, consIndex);
        });

    </script>
</body>
</html>