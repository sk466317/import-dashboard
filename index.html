<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Report Pro | Professional Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Screenshot logic -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase state attachment to window
        window.fb = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, onSnapshot };
    </script>

    <style>
        body { 
            font-family: Arial, Helvetica, sans-serif; 
            letter-spacing: -0.01em; 
            background-color: #CBD5E1; 
        }
        .font-arial-black {
            font-family: "Arial Black", Gadget, sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes status-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-status-icon svg {
            animation: status-pulse 2s infinite ease-in-out;
        }

        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .report-paper { border: none !important; box-shadow: none !important; width: 100% !important; margin: 0 !important; }
        }

        table { border-collapse: collapse; width: 100%; table-layout: auto; border: 1px solid #1e3a8a33; }
        th, td { border: 1px solid #1e3a8a33; word-wrap: break-word; line-height: 1.2; padding: 4px 6px; }
        
        .report-box {
            border: 1px solid #94a3b8; 
            background-color: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .font-bold { font-weight: 700; }
        .compact-header { padding-top: 0.4rem; padding-bottom: 0.4rem; }
        .row-compact td { padding-top: 0.25rem; padding-bottom: 0.25rem; }

        .filter-select {
            background-color: #eff6ff; 
            border: 2px solid #1d4ed8; 
            border-radius: 0.375rem;
            padding: 0.15rem 1.5rem 0.15rem 0.5rem;
            font-size: 9px;
            font-weight: 800;
            color: #1d4ed8; 
            text-transform: uppercase;
            outline: none;
            cursor: pointer;
            min-width: 130px;
            transition: all 0.2s;
        }
        .filter-select:focus { 
            border-color: #1e40af;
            box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.1);
        }

        /* Login Screen Styles */
        #loginScreen {
            position: fixed;
            inset: 0;
            background-color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        #loginScreen.hidden {
            display: none !important;
            pointer-events: none;
        }

        /* Update Data Modal Styles */
        #updateModal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            padding: 20px;
        }
        
        /* Manual Date Entry Modal - Highest Priority Layering */
        #manualDateModal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75);
            backdrop-filter: blur(6px); /* Blurs everything behind, including other modals */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999; /* Set to very high value to always be on top */
            padding: 20px;
        }
        
        #updateModal.hidden, #manualDateModal.hidden {
            display: none !important;
        }
        
        .editable-cell:focus {
            background-color: #fef9c3;
            outline: 2px solid #eab308;
            border-radius: 2px;
        }

        .delete-row-btn:hover {
            color: #e11d48;
            transform: scale(1.1);
        }
/* Progress Bar Style */
#saveProgressContainer {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 4px;
    background: rgba(255,255,255,0.1); z-index: 100000; display: none;
}
#saveProgressBar {
    height: 100%; width: 0%; background: #22c55e; transition: width 0.3s ease;
}
    </style>
</head>
<body class="text-slate-900 h-screen flex flex-col overflow-hidden">
<div id="saveProgressContainer"><div id="saveProgressBar"></div></div>
    <!-- Login Screen Overlay -->
    <div id="loginScreen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-200">
            <div class="flex flex-col items-center mb-6">
                <div class="bg-blue-700 p-3 rounded-2xl text-white shadow-lg mb-4">
                    <i data-lucide="lock" class="w-8 h-8"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800 uppercase tracking-tight">Secured Access</h2>
                <p class="text-slate-500 text-xs font-semibold">Enter password to continue</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="loginPassword" placeholder="••••••••" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-xl font-bold text-center tracking-widest focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <button id="authBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-xl shadow-lg transition-all transform active:scale-95">
                    AUTHENTICATE
                </button>
                <div id="loginError" class="text-rose-600 text-[10px] font-bold text-center hidden uppercase">Invalid Password! Please try again.</div>
            </div>
            <div class="mt-8 text-center">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Hind Terminals Import Dashboard v2.0(Generated by: Vikram Singh)</p>
            </div>
        </div>
    </div>

    <!-- Update Data Modal -->
    <div id="updateModal" class="hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[98vw] h-[95vh] flex flex-col border border-slate-300 overflow-hidden">
            <div class="bg-slate-900 p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3 text-white">
                    <i data-lucide="database" class="w-5 h-5 text-red-500"></i>
                    <h2 class="font-bold uppercase tracking-tight text-sm">Update & View Source Data</h2>
                </div>
                <div class="flex items-center gap-4">
                    <button id="deleteAllRowsBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg font-bold text-[9px] uppercase transition-all flex items-center gap-1.5 shadow-sm active:scale-95">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        Complete Data Delete
                    </button>
                    <button id="closeModalBtn" class="text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-3 bg-slate-100 border-b border-slate-200 flex flex-col gap-3 shrink-0">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex gap-2">
                        <button id="tabShipper" class="sheet-tab-btn px-4 py-2 bg-white border border-slate-300 rounded-lg font-bold text-[10px] uppercase hover:bg-blue-50 transition-all" data-sheet="shipper">SHIPPER</button>
                        <button id="tabSmtp" class="sheet-tab-btn px-4 py-2 bg-white border border-slate-300 rounded-lg font-bold text-[10px] uppercase hover:bg-blue-50 transition-all" data-sheet="smtp">SMTP</button>
                        <button id="tabWebsite" class="sheet-tab-btn px-4 py-2 bg-white border border-slate-300 rounded-lg font-bold text-[10px] uppercase hover:bg-blue-50 transition-all" data-sheet="website">WEBSITE</button>
                    </div>

                    <!-- Shipper Tab Context Tools -->
                    <div id="shipperUpdateSection" class="hidden items-center gap-3 bg-white p-2 rounded-xl border border-slate-300 shadow-sm flex-wrap">
                        <label class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded-lg font-bold text-[10px] cursor-pointer transition-all flex items-center gap-2 shadow-sm uppercase">
                            <i data-lucide="file-up" class="w-3.5 h-3.5"></i>
                            UPLOAD SHIPPER EXCEL
                            <input type="file" id="shipperExcelInput" class="hidden" accept=".xlsx, .xls">
                        </label>
                        <p class="text-[9px] font-bold text-slate-400 italic">Expected Headers: A=CONT_Nos., B=Size, C=BL_No., D=Consignee</p>
                    </div>

                    <!-- SMTP Tab Context Tools -->
                    <div id="smtpUpdateSection" class="hidden items-center gap-3 bg-white p-2 rounded-xl border border-slate-300 shadow-sm flex-wrap">
                        <label class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg font-bold text-[10px] cursor-pointer transition-all flex items-center gap-2 shadow-sm uppercase">
                            <i data-lucide="file-up" class="w-3.5 h-3.5"></i>
                            UPLOAD SMTP EXCEL
                            <input type="file" id="smtpExcelInput" class="hidden" accept=".xlsx, .xls">
                        </label>
                        <p class="text-[9px] font-bold text-slate-400 italic">Checks Cell L (12th Col) for "KILARAIPUR/LUDHIANA" & skips duplicates.</p>
                    </div>

                    <!-- Website Tab Context Tools -->
                    <div id="websiteUpdateSection" class="hidden items-center gap-3 bg-white p-2 rounded-xl border border-slate-300 shadow-sm flex-wrap">
                        <div class="flex items-center gap-2 border-r border-slate-200 pr-3">
                            <select id="rakeSelect" class="bg-slate-50 border border-slate-300 text-[10px] font-bold rounded-lg px-2 py-1.5 outline-none w-44">
                                <option value="">Select Rake No</option>
                            </select>
                            
                            <div class="flex flex-col">
                                <span class="text-[7px] font-bold text-blue-700 uppercase ml-1 mb-0.5 tracking-tighter">RAILING_DATE</span>
                                <input type="text" id="railDateDisplay" placeholder="Rail Date" readonly class="bg-slate-100 border border-slate-200 text-[10px] font-bold rounded-lg px-2 py-1.5 w-32 outline-none text-slate-700">
                            </div>

                            <div class="h-6 w-px bg-slate-200 mx-1"></div>
                            
                            <!-- Arrival Date Box -->
                            <div class="flex items-center gap-1.5">
                                <input type="text" id="arrivedDateInput" placeholder="Arrival Date (dd-mm-yy hh:mm)" class="bg-blue-50 border border-blue-200 text-[10px] font-bold rounded-lg px-2 py-1.5 w-44 outline-none focus:ring-1 focus:ring-blue-500">
                                <button id="updateArrivedBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-bold text-[9px] uppercase transition-all shadow-sm flex items-center gap-1">
                                    <i data-lucide="check-circle" class="w-3 h-3"></i>
                                    Update Arrived
                                </button>
                            </div>

                            <div class="h-6 w-px bg-slate-200 mx-1"></div>

                            <!-- Remarks Update Box (Updated with Larger Width) -->
                            <div class="flex items-center gap-1.5">
                                <input type="text" id="customRemarksInput" placeholder="Edit Remarks for selected Rake..." class="bg-amber-50 border border-amber-200 text-[10px] font-bold rounded-lg px-2 py-1.5 w-96 outline-none focus:ring-1 focus:ring-amber-500">
                                <button id="updateCustomRemarksBtn" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-1.5 rounded-lg font-bold text-[9px] uppercase transition-all shadow-sm flex items-center gap-1">
                                    <i data-lucide="edit-3" class="w-3 h-3"></i>
                                    Update Remarks
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 pl-1">
                            <button id="addSmtpBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg font-bold text-[10px] transition-all flex items-center gap-2 uppercase">
                                <i data-lucide="list-plus" class="w-3.5 h-3.5"></i>
                                Add SMTP
                            </button>
                            <label class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-lg font-bold text-[10px] cursor-pointer transition-all flex items-center gap-2 shadow-sm">
                                <i data-lucide="file-up" class="w-3.5 h-3.5"></i>
                                UPDATE RAILOUT
                                <input type="file" id="websiteExcelInput" class="hidden" accept=".xlsx, .xls">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-auto p-4 custom-scrollbar bg-slate-50">
                <div id="sheetDataContainer" class="bg-white rounded-lg border border-slate-200 min-w-full overflow-x-auto">
                    <div class="p-20 text-center text-slate-400 flex flex-col items-center">
                        <i data-lucide="table" class="w-12 h-12 mb-2 opacity-20"></i>
                        <p class="font-bold text-xs uppercase tracking-widest">Select a sheet to view its contents</p>
                    </div>
                </div>
            </div>
            
            <div class="p-3 bg-white border-t border-slate-200 flex justify-between items-center shrink-0">
                <p class="text-[9px] font-bold text-slate-400 uppercase italic">Changes are local until "Save Changes" is clicked.</p>
                <div class="flex gap-2">
                    <button id="saveLocalChangesBtn" class="px-6 py-2 bg-blue-700 text-white rounded-lg font-bold text-[10px] uppercase hover:bg-blue-800 shadow-md transition-all">Save Changes</button>
                    <button id="closeModalBtnFooter" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold text-[10px] uppercase hover:bg-slate-300 transition-all">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Date Entry Modal -->
    <div id="manualDateModal" class="hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 border-4 border-blue-600 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-blue-600"></div>
            <div class="flex items-center gap-3 mb-4 text-blue-700">
                <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                <h3 class="font-bold uppercase text-sm tracking-tight">Manual Railout Date Entry</h3>
            </div>
            <p class="text-slate-600 text-[11px] font-bold mb-5 uppercase leading-relaxed">Excel data (Cell AH11) is empty. Please enter the Railout Date manually below to calculate ETA remarks.</p>
            <div class="space-y-4">
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <label class="text-[9px] font-black text-slate-400 uppercase mb-1.5 block">Format: dd-mm-yy hh:mm</label>
                    <input type="text" id="manualRailDateInput" placeholder="21-12-25 03:00" class="w-full px-4 py-2.5 bg-white border border-slate-300 rounded-lg font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner">
                </div>
                <div class="flex gap-2 mt-2">
                    <button id="submitManualDateBtn" class="flex-1 bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-lg text-[10px] uppercase shadow-lg transition-all transform active:scale-95">Update Remarks</button>
                    <button id="cancelManualDateBtn" class="px-4 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-lg text-[10px] uppercase transition-all active:scale-95">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-400 px-6 compact-header flex justify-between items-center shadow-sm shrink-0 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-blue-700 p-1.5 rounded-lg text-white shadow-md">
                <i data-lucide="ship" class="w-4 h-4"></i>
            </div>
            <div>
                <h1 class="text-md font-bold text-slate-800 tracking-tight uppercase">Import Dashbord</h1>
                <p class="text-[8px] font-bold text-blue-600 uppercase tracking-widest leading-none">Hind Terminals Pvt Ltd</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div id="cloudStatus" class="text-[9px] font-bold text-slate-400 px-2 flex items-center gap-1">
                <span id="cloudIndicator" class="w-2 h-2 rounded-full bg-slate-300"></span>
                <span id="cloudLabel">Connecting...</span>
            </div>

            <!-- Update Data Button -->
            <button id="openUpdateModalBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-md font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-sm">
                <i data-lucide="database" class="w-3 h-3"></i>
                UPDATE DATA
            </button>
            
            <!-- Image Save Button -->
            <button id="saveImageBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-md font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-sm">
                <i data-lucide="image" class="w-3 h-3"></i>
                SAVE PNG
            </button>

            <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-sm">
                <i data-lucide="refresh-cw" class="w-3 h-3" id="refreshIcon"></i>
                REFRESH
            </button>
            <div id="upload-section">
                <label class="bg-slate-900 hover:bg-black text-white px-3 py-1.5 rounded-md font-bold text-[10px] cursor-pointer transition-all flex items-center gap-1.5 shadow-sm">
                    <i data-lucide="plus" class="w-3 h-3"></i>
                    UPLOAD
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls">
                </label>
            </div>
            <button id="downloadBtn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-md font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-sm">
                <i data-lucide="download" class="w-3 h-3"></i>
                EXPORT
            </button>
            <button id="resetBtn" class="hidden text-slate-500 hover:text-red-500 font-bold text-[10px] px-2">Reset</button>
        </div>
    </header>

    <main id="mainContent" class="flex-1 flex overflow-hidden">
        <aside class="w-60 bg-blue-200 border-r border-slate-400 flex flex-col shrink-0 no-print" id="sidebarContainer">
            <div class="p-3 border-b border-slate-200">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400"></i>
                    <input type="text" id="shipperSearch" placeholder="Select Special Shippers" class="w-full pl-8 pr-3 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-[10px] font-bold outline-none focus:ring-2 focus:ring-green-800 shadow-sm">
                </div>
            </div>
<div class="p-3 border-b border-slate-400 bg-blue-200/50">
    <div class="relative mb-2">
        <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-blue-600"></i>
        <input type="text" id="smtpBlSearch" placeholder="Search By B/L No " class="w-full pl-8 pr-3 py-1.5 bg-white border border-blue-400 rounded-lg text-[10px] font-bold outline-none focus:ring-2 focus:ring-orange-800 shadow-sm">
    </div>
    <div id="smtpConsigneeBox" class="p-2 bg-white rounded-lg border-2 border-blue-400 hidden cursor-pointer hover:bg-blue-600 hover:text-white transition-all shadow-md group">
        <p class="text-[7px] text-blue-500 font-bold uppercase group-hover:text-blue-100">Found Consignee (SMTP):</p>
        <p id="smtpConsigneeName" class="text-[9px] font-black break-words uppercase"></p>
        <p class="text-[6px] mt-1 italic opacity-70">Click to generate SMTP report</p>
    </div>
</div>
<div class="p-3 border-b border-slate-200 bg-blue-50 hidden">
    <div class="relative mb-2">
        <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-blue-500"></i>
        <input type="text" id="blDataSearch" placeholder="Search BL No..." class="w-full pl-8 pr-3 py-1.5 bg-white border border-blue-300 rounded-lg text-[10px] font-bold outline-none focus:ring-1 focus:ring-blue-500">
    </div>
    <div id="consigneeDisplay" class="p-2 bg-white rounded border border-blue-200 hidden cursor-pointer hover:bg-blue-100 transition-all active:scale-95 shadow-sm" title="Click to view report">
    <p class="text-[7px] text-blue-500 font-bold uppercase flex items-center gap-1">
        <i data-lucide="external-link" class="w-2 h-2"></i> View Report for:
    </p>
    <p id="consigneeValue" class="text-[9px] font-black text-slate-800 break-words uppercase"></p>
</div>

</div>
            <div id="shipperList" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1"></div>
        </aside>

        <section id="mainSectionArea" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4 print:p-0 bg-slate-200">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-center p-12 bg-white rounded-2xl border border-slate-400 shadow-lg no-print mx-auto max-w-lg mt-20">
                <i data-lucide="file-spreadsheet" class="w-12 h-12 text-slate-300 mb-3"></i>
                <h2 class="text-lg font-bold text-slate-800 uppercase tracking-tight">System Ready</h2>
                <p class="text-slate-500 text-xs font-bold">Please upload a file or wait for cloud sync.</p>
            </div>

            <!-- Dashboard Content -->
            <div id="reportContainer" class="hidden space-y-5 max-w-[1300px] mx-auto p-4 bg-slate-200">
                <!-- Statistics Section -->
                <div id="overallStats" class="grid grid-cols-6 gap-3 font-arial-black text-center"></div>

                <div class="report-box print:border-none print:shadow-none bg-white">
                    <div class="px-5 py-2 bg-white border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full">
                            <h2 id="activeShipperName" class="text-sm font-bold text-slate-900 tracking-tight uppercase shrink-0"></h2>
                            <div class="flex items-center gap-4 no-print">
                                <div class="flex items-center gap-2">
                                    <label class="text-[9px] font-extrabold text-blue-700 uppercase tracking-tight">Vessel Wise:</label>
                                    <select id="vesselFilter" class="filter-select">
                                        <option value="ALL">All Vessels</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-[9px] font-extrabold text-blue-700 uppercase tracking-tight">BL Wise:</label>
                                    <select id="blFilter" class="filter-select">
                                        <option value="ALL">All BLs</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <span id="currentTime" class="text-[9px] font-bold text-slate-500 uppercase shrink-0"></span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-[10px]">
                            <thead>
                                <tr class="bg-slate-900 text-white font-bold uppercase tracking-wider">
                                    <th class="px-2 py-2">BL NO</th>
                                    <th class="px-2 py-2 w-20">LINE</th>
                                    <th class="px-2 py-2">Disch_Vsl_Name</th>
                                    <th class="px-2 py-2 text-center w-28 uppercase">Handover Date</th>
                                    <th class="px-1.5 py-2 text-center bg-slate-800 w-10">20</th>
                                    <th class="px-1.5 py-2 text-center bg-slate-800 w-10">40</th>
                                    <th class="px-1.5 py-2 text-center bg-emerald-700 w-24 whitespace-normal uppercase">Railout Done</th>
                                    <th class="px-1.5 py-2 text-center bg-blue-600 w-20 whitespace-normal uppercase">Arrived</th>
                                    <th class="px-1.5 py-2 text-center bg-orange-600 w-20 whitespace-normal uppercase">In Transit</th>
                                    <th class="px-1.5 py-2 text-center bg-rose-700 w-24 whitespace-normal uppercase">Pending Port</th>
                                </tr>
                            </thead>
                            <tbody id="reportRows" class="font-bold text-slate-700 row-compact"></tbody>
                            <tfoot id="reportFooter" class="bg-slate-100 font-bold text-slate-900 border-t border-slate-300"></tfoot>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-5 pb-10">
                    <div id="railedBreakdownContainer" class="report-box bg-white">
                        <div class="bg-emerald-600 px-4 py-1.5 flex justify-between items-center">
                            <div class="flex items-center gap-2 text-white animate-status-icon">
                                <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                                <h3 id="railedShipmentsHeading" class="font-bold uppercase tracking-widest text-[9px]">Railed Out Shipments</h3>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-[9px]">
                                <thead class="bg-emerald-50 text-emerald-900 font-bold uppercase">
                                    <tr>
                                        <th class="px-3 py-2">BL (Containers/Line)</th>
                                        <th class="px-3 py-2 text-center w-24 whitespace-normal uppercase">Railout Done</th>
                                        <th class="px-3 py-2">Train No / Rake</th>
                                        <th class="px-3 py-2 text-center w-28">Railout Date</th>
                                        <th class="px-3 py-2 uppercase">Current Train Location and ETA</th>
                                    </tr>
                                </thead>
                                <tbody id="railedDetailRows" class="font-bold text-slate-600 row-compact"></tbody>
                                <tfoot id="railedDetailFooter" class="bg-emerald-50 text-emerald-900 font-bold uppercase border-t border-emerald-200"></tfoot>
                            </table>
                        </div>
                    </div>

                    <div id="pendingBreakdownContainer" class="report-box bg-white">
                        <div class="bg-rose-600 px-4 py-1.5 flex justify-between items-center text-white">
                            <div class="flex items-center gap-2 animate-status-icon">
                                <i data-lucide="clock" class="w-3.5 h-3.5"></i>
                                <h3 class="font-bold uppercase tracking-widest text-[9px]">Pending Shipments</h3>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-[9px]">
                                <thead class="bg-rose-50 text-rose-900 font-bold uppercase">
                                    <tr>
                                        <th class="px-3 py-2">BL (Containers/Line)</th>
                                        <th class="px-3 py-2">Remarks (SMTP B)</th>
                                        <th class="px-3 py-2 text-center w-24">PENDING</th>
                                        <th class="px-3 py-2 uppercase">Vessel</th>
                                        <th class="px-3 py-2 text-center w-28 uppercase">Handover Date</th>
                                        <th class="px-3 py-2 uppercase">Current Status</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingDetailRows" class="font-bold text-slate-600 row-compact"></tbody>
                                <tfoot id="pendingDetailFooter" class="bg-rose-50 text-rose-900 font-bold uppercase border-t border-rose-200"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
// New BL Search & Report Trigger Logic
document.getElementById('blDataSearch').addEventListener('input', (e) => {
    const searchVal = e.target.value.trim().toUpperCase();
    const displayBox = document.getElementById('consigneeDisplay');
    const valueEl = document.getElementById('consigneeValue');

    if (searchVal.length > 3 && rawSheets.smtp.length > 1) {
        // SMTP: Cell 10 (Index 9) = BL No, Cell 25 (Index 24) = Consignee
        const match = rawSheets.smtp.find(row => String(row[9] || '').toUpperCase().includes(searchVal));
        
        if (match && match[24]) {
            const consigneeName = String(match[24]).trim();
            valueEl.innerText = consigneeName;
            displayBox.classList.remove('hidden');
            
            // Jab Consignee Box par click ho
            displayBox.onclick = () => {
                const headers = rawSheets.shipper[0];
                // Shipper sheet mein Consignee column ka index dhundo
                const consIndexInShipper = headers.findIndex(h => String(h).toUpperCase().includes('CONSIGNEE'));
                
                if (consIndexInShipper !== -1) {
                    // Report generate karne wala main function call karein
                    window.selectShipper(consigneeName, consIndexInShipper);
                    
                    // Search box reset karein (Optional)
                    e.target.value = ''; 
                    displayBox.classList.add('hidden');
                } else {
                    alert("Consignee column not found in Shipper sheet!");
                }
            };
        } else {
            displayBox.classList.add('hidden');
        }
    } else {
        displayBox.classList.add('hidden');
    }
});
        // ==========================================
        // Firebase Configuration (Consolidated)
        // ==========================================
        const MY_CUSTOM_CONFIG = {
            apiKey: "AIzaSyBo1ZvNlwQN_s3k7XmyaD_-q0ikydEijFs",
            authDomain: "logistic-c6a6a.firebaseapp.com",
            projectId: "logistic-c6a6a",
            storageBucket: "logistic-c6a6a.firebasestorage.app",
            messagingSenderId: "270575499830",
            appId: "1:270575499830:web:cc280133d6cdde224b7697",
            measurementId: "G-YQ30N12NF7"
        };

        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, onSnapshot } = window.fb;
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MY_CUSTOM_CONFIG;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : "logistic-c6a6a-dashboard";
        let isCloudEnabled = true;

        // UI & State References
        const cloudIndicator = document.getElementById('cloudIndicator');
        const cloudLabel = document.getElementById('cloudLabel');
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const saveImageBtn = document.getElementById('saveImageBtn');
        const openUpdateModalBtn = document.getElementById('openUpdateModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalBtnFooter = document.getElementById('closeModalBtnFooter');
        const saveLocalChangesBtn = document.getElementById('saveLocalChangesBtn');
        const authBtn = document.getElementById('authBtn');
        const loginScreen = document.getElementById('loginScreen');
        const vesselFilter = document.getElementById('vesselFilter');
        const blFilter = document.getElementById('blFilter');
        const shipperSearch = document.getElementById('shipperSearch');
        const fileInput = document.getElementById('fileInput');

        // Website Tools
        const rakeSelect = document.getElementById('rakeSelect');
        const railDateDisplay = document.getElementById('railDateDisplay');
        const arrivedDateInput = document.getElementById('arrivedDateInput');
        const updateArrivedBtn = document.getElementById('updateArrivedBtn');
        const customRemarksInput = document.getElementById('customRemarksInput');
        const updateCustomRemarksBtn = document.getElementById('updateCustomRemarksBtn');

        let rawSheets = { shipper: [], smtp: [], website: [] };
        let selectedShipper = null;
        let currentSheetInView = null;
        let trainDateRemarksMap = {}; 
        let currentShipperAllGroups = []; 
        let isInTransitFilterActive = false; // New global filter state

        lucide.createIcons();

        // ------------------------------------------
        // 1. DATE & HOISTED FUNCTIONS
        // ------------------------------------------
        function formatToDDMMYYYY(val) {
            if (!val || val === '-' || val === 'N/A' || val === '') return val;
            let date;
            const numVal = parseFloat(val);
            const looksNumeric = !isNaN(numVal) && isFinite(val) && !String(val).includes('-') && !String(val).includes('/');
            
            if (looksNumeric && numVal > 40000) {
                date = new Date(Math.round((numVal - 25569) * 86400 * 1000));
            } else if (typeof val === 'number') {
                date = new Date(Math.round((val - 25569) * 86400 * 1000));
            } else {
                date = new Date(val);
                if (isNaN(date.getTime()) && String(val).includes('-')) {
                    const parts = String(val).split('-');
                    if (parts.length === 3) {
                        if (parts[0].length === 4) date = new Date(parts[0], parts[1]-1, parts[2]);
                        else date = new Date(parts[2], parts[1]-1, parts[0]);
                    }
                }
            }
            if (isNaN(date.getTime())) return val;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hh}:${mm}`;
        }

        function formatToDDMMYY_HHMM(val) {
            const f = formatToDDMMYYYY(val);
            if (!f || !f.includes('-') || f.length < 10) return f;
            return f.substring(0, 6) + f.substring(8);
        }

        // Globalized helper to close modal
        window.hideModal = function() {
            document.getElementById('updateModal').classList.add('hidden');
        };

        // Toggle logic for In Transit filter
        window.toggleInTransitFilter = function() {
            isInTransitFilterActive = !isInTransitFilterActive;
            applyFilters(); // Re-renders all tables using existing filter chain
        };

        // ------------------------------------------
        // 2. RENDERING LOGIC
        // ------------------------------------------
        function applyFilters() {
            if (!currentShipperAllGroups.length) return;
            let filtered = [...currentShipperAllGroups];
            const vVal = vesselFilter.value;
            const bVal = blFilter.value;
            if (vVal !== "ALL") filtered = filtered.filter(g => g.vessel === vVal);
            if (bVal !== "ALL") filtered = filtered.filter(g => g.blNo === bVal);
            renderStats(filtered);
            renderMainTable(filtered);
            renderDetailedBreakdown(filtered);
        }

        function renderStats(groups) {
            const t20 = groups.reduce((acc, b) => acc + b.stats.s20, 0);
            const t40 = groups.reduce((acc, b) => acc + b.stats.s40, 0);
            const r20 = groups.reduce((acc, b) => acc + b.stats.r20, 0);
            const r40 = groups.reduce((acc, b) => acc + b.stats.r40, 0);
            const p20 = groups.reduce((acc, b) => acc + b.stats.p20, 0);
            const p40 = groups.reduce((acc, b) => acc + b.stats.p40, 0);
            
            let totalArrived = 0;
            groups.forEach(bl => {
                bl.railedDetails.forEach(d => {
                    if (/TRAIN ARRIVED/i.test(d.remark)) {
                        totalArrived += d.count;
                    }
                });
            });
            const totalRailed = r20 + r40;
            const totalInTransit = totalRailed - totalArrived;

            const formatSubCount = (c20, c40, colorClass) => {
                let parts = [];
                if (c20 > 0) parts.push(`<span class="${colorClass}">(${c20} <span class="text-[8px]">x</span> 20")</span>`);
                if (c40 > 0) parts.push(`<span class="${colorClass}">(${c40} <span class="text-[8px]">x</span> 40")</span>`);
                return parts.join(' ');
            };
            const subColor = "text-blue-900 font-bold text-[12px]";
            
            // Note: Added border-blue-600 and ring logic for active filter state on In Transit box
            document.getElementById('overallStats').innerHTML = `
                <div class="bg-white p-2 rounded-xl border-b-4 border-b-orange-500 border border-slate-400 shadow-sm flex flex-col items-center">
                    <span class="text-[7px] font-bold text-slate-400 uppercase tracking-widest">Total Containers</span>
                    <span class="text-lg font-bold text-slate-900">${t20 + t40}</span>
                    <div class="mt-0.5">${formatSubCount(t20, t40, subColor)}</div>
                </div>
                <div class="bg-emerald-50 p-2 rounded-xl border-b-4 border-b-emerald-500 border border-slate-400 shadow-sm flex flex-col items-center">
                    <span class="text-[7px] font-bold text-emerald-600 uppercase tracking-widest">Railout Done</span>
                    <span class="text-lg font-bold text-emerald-700">${totalRailed}</span>
                    <div class="mt-0.5">${formatSubCount(r20, r40, subColor)}</div>
                </div>
                <div class="bg-blue-50 p-2 rounded-xl border-b-4 border-b-blue-600 border border-slate-400 shadow-sm flex flex-col items-center">
                    <span class="text-[7px] font-bold text-blue-600 uppercase tracking-widest">Arrived</span>
                    <span class="text-lg font-bold text-blue-700">${totalArrived}</span>
                    <span class="text-[8px] font-bold text-slate-400 mt-1 uppercase">Units Received</span>
                </div>
                <div onclick="window.toggleInTransitFilter()" class="cursor-pointer bg-amber-50 p-2 rounded-xl border-b-4 border-b-amber-500 border border-slate-400 shadow-sm flex flex-col items-center transition-all hover:bg-amber-100 ${isInTransitFilterActive ? 'ring-4 ring-blue-500 ring-opacity-50 border-blue-500' : ''}">
                    <span class="text-[7px] font-bold text-amber-600 uppercase tracking-widest">${isInTransitFilterActive ? 'Filtering Mundra...' : 'In Transit'}</span>
                    <span class="text-lg font-bold text-amber-700">${totalInTransit}</span>
                    <span class="text-[8px] font-bold text-slate-400 mt-1 uppercase">Click to Filter</span>
                </div>
                <div class="bg-rose-50 p-2 rounded-xl border-b-4 border-b-rose-500 border border-slate-400 shadow-sm flex flex-col items-center">
                    <span class="text-[7px] font-bold text-rose-600 uppercase tracking-widest">Pending</span>
                    <span class="text-lg font-bold text-rose-700">${p20 + p40}</span>
                    <div class="mt-0.5">${formatSubCount(p20, p40, subColor)}</div>
                </div>
                <div class="bg-white p-2 rounded-xl border-b-4 border-b-blue-600 border border-slate-400 shadow-sm flex flex-col items-center">
                    <span class="text-[7px] font-bold text-blue-500 uppercase tracking-widest">Total B/L</span>
                    <span class="text-xl font-bold text-blue-600 mt-0.5 leading-none">${groups.length}</span>
                </div>`;
        }

        function renderMainTable(groups) {
            let g20 = 0, g40 = 0, gR = 0, gA = 0, gT = 0, gP = 0;
            document.getElementById('reportRows').innerHTML = groups.map(bl => {
                g20 += bl.stats.s20; g40 += bl.stats.s40; gR += bl.stats.railed; gP += bl.stats.pending;
                const arrivedCount = bl.railedDetails.reduce((acc, d) => /TRAIN ARRIVED/i.test(d.remark) ? acc + d.count : acc, 0);
                const inTransitCount = bl.stats.railed - arrivedCount;
                gA += arrivedCount;
                gT += inTransitCount;
                
                const progressPercent = bl.stats.total > 0 ? Math.round((arrivedCount / bl.stats.total) * 100) : 0;
                const sizeLabel = `(${bl.stats.total}X${bl.stats.s40 > 0 ? '40' : '20'})`;
                const vesselDisplay = (!bl.isAnySmtp && bl.stats.railed === 0) ? '<span class="text-rose-600 font-bold italic">NOT Handover</span>' : bl.vessel;
                
                return `
                    <tr class="border-b border-slate-200 hover:bg-slate-50 transition-colors">
                        <td class="px-2 py-1 border-r border-slate-300 min-w-[160px] relative overflow-hidden group">
                            <!-- Background Fill % Wise -->
                            <div class="absolute top-0 left-0 h-full bg-green-200/60 transition-all duration-1000 ease-out z-0 pointer-events-none" style="width: ${progressPercent}%"></div>
                            
                            <!-- Content Box -->
                            <div class="relative z-10 flex flex-col">
                                <div class="flex justify-between items-center mb-0.5">
                                    <span class="font-bold text-slate-900 truncate pr-1">
                                        <span class="text-pink-600 text-[8.5px] font-black mr-1">${progressPercent}%</span> 
                                        ${bl.blNo} 
                                        <span class="text-black-600 text-[9px] uppercase font-bold">${sizeLabel}</span>
                                    </span>
                                </div>
                                <!-- Tiny progress separator for extra detail if needed, otherwise hidden -->
                                <div class="w-full h-0 bg-slate-200/50 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-400" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-2 py-1 text-slate-600 border-r border-slate-300 font-bold uppercase truncate">${bl.line}</td>
                        <td class="px-2 py-1 text-slate-700 border-r border-slate-300 font-bold uppercase truncate">${vesselDisplay}</td>
                        <td class="px-2 py-1 text-slate-500 border-r border-slate-300 text-center font-bold uppercase text-[9px]">${bl.handoverDt}</td>
                        <td class="px-1 py-1 text-center border-r border-slate-300 bg-slate-50/50 ${bl.stats.s20 > 0 ? 'text-slate-800' : 'text-slate-200'}">${bl.stats.s20 || '-'}</td>
                        <td class="px-1 py-1 text-center border-r border-slate-300 bg-slate-50/50 ${bl.stats.s40 > 0 ? 'text-slate-800' : 'text-slate-200'}">${bl.stats.s40 || '-'}</td>
                        <td class="px-1.5 py-1 text-center border-r border-slate-300 bg-emerald-50 text-emerald-700">${bl.stats.railed || '-'}</td>
                        <td class="px-1.5 py-1 text-center border-r border-slate-300 bg-blue-50 text-blue-700">${arrivedCount || '-'}</td>
                        <td class="px-1.5 py-1 text-center border-r border-slate-300 bg-orange-50 text-orange-700">${inTransitCount || '-'}</td>
                        <td class="px-1.5 py-1 text-center border-r border-slate-300 bg-rose-50 text-rose-700">${bl.stats.pending || '-'}</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('reportFooter').innerHTML = `
                <tr class="bg-slate-100 text-slate-900">
                    <td colspan="4" class="px-2 py-1.5 text-right uppercase font-bold text-slate-500 text-[9px]">Grand Totals</td>
                    <td class="px-1 py-1.5 text-center text-xs font-bold border-r border-slate-300">${g20}</td>
                    <td class="px-1 py-1.5 text-center text-xs font-bold border-r border-slate-300">${g40}</td>
                    <td class="px-1.5 py-1.5 text-center text-xs font-bold text-emerald-700 border-r border-slate-300">${gR}</td>
                    <td class="px-1.5 py-1.5 text-center text-xs font-bold text-blue-700 border-r border-slate-300">${gA}</td>
                    <td class="px-1.5 py-1.5 text-center text-xs font-bold text-orange-700 border-r border-slate-300">${gT}</td>
                    <td class="px-1.5 py-1.5 text-center text-xs font-bold text-rose-700">${gP}</td>
                </tr>
            `;
        }

        function renderDetailedBreakdown(groups) {
            const railedGroups = groups.filter(g => g.stats.railed > 0);
            const pendingGroups = groups.filter(g => g.stats.pending > 0);
            let totalRailedUnits = 0, totalPendingUnits = 0;

            // Header Update for Railed Shipments when filter is active
            const headingEl = document.getElementById('railedShipmentsHeading');
            if (headingEl) {
                headingEl.innerText = isInTransitFilterActive ? "Railed Out Shipments (Filtered: Mundra Railout)" : "Railed Out Shipments";
            }

            if (railedGroups.length === 0) document.getElementById('railedBreakdownContainer').classList.add('hidden');
            else {
                document.getElementById('railedBreakdownContainer').classList.remove('hidden');
                let rHtml = '';
                railedGroups.forEach(bl => {
                    // Logic to filter rows by RAILOUT FROM MUNDRA if active
                    let detailsToShow = bl.railedDetails;
                    if (isInTransitFilterActive) {
                        detailsToShow = detailsToShow.filter(d => /RAILOUT FROM MUNDRA/i.test(d.remark));
                    }

                    if (detailsToShow.length > 0) {
                        let blTotal = 0;
                        detailsToShow.forEach((detail, idx) => {
                            totalRailedUnits += detail.count;
                            blTotal += detail.count;
                            const isArrived = /TRAIN ARRIVED/i.test(detail.remark);
                            const remarkClass = isArrived ? 'bg-yellow-100 text-slate-900' : 'text-slate-500';
                            rHtml += `<tr class="border-b border-slate-200 hover:bg-emerald-50/30">`;
                            if (idx === 0) rHtml += `<td rowspan="${detailsToShow.length}" class="px-3 py-1 font-bold text-slate-900 border-r border-slate-300 align-top">${bl.blNo} <span class="text-blue-500 text-[8px] uppercase font-bold">(${bl.stats.total} / ${bl.line})</span></td>`;
                            rHtml += `<td class="px-3 py-1 text-center font-bold text-emerald-700 bg-emerald-50 border-r border-slate-300">${detail.count}</td><td class="px-3 py-1 text-slate-700 font-bold uppercase border-r border-slate-300">${detail.train}</td><td class="px-3 py-1 text-center text-blue-600 font-bold border-r border-slate-300 uppercase whitespace-nowrap">${detail.date}</td><td class="px-3 py-1 ${remarkClass} text-[9px] font-bold">${detail.remark}</td></tr>`;
                        });
                        rHtml += `<tr class="bg-blue-100/60 font-bold border-b border-blue-200"><td class="px-3 py-1 text-blue-800 uppercase text-[8px]">Group Total</td><td class="px-3 py-1 text-center text-blue-900 border-r border-blue-200">${blTotal}</td><td colspan="3"></td></tr>`;
                    }
                });
                document.getElementById('railedDetailRows').innerHTML = rHtml;
                document.getElementById('railedDetailFooter').innerHTML = `<tr class="bg-emerald-50 text-emerald-800 font-bold"><td class="px-3 py-1.5 text-right uppercase text-[9px]">Grand Total (Viewed)</td><td class="px-3 py-1.5 text-center text-[11px] border-r border-emerald-200">${totalRailedUnits}</td><td colspan="3"></td></tr>`;
            }

            if (pendingGroups.length === 0) document.getElementById('pendingBreakdownContainer').classList.add('hidden');
            else {
                document.getElementById('pendingBreakdownContainer').classList.remove('hidden');
                let pHtml = '';
                pendingGroups.forEach(bl => {
                    totalPendingUnits += bl.stats.pending;
                    const statusLabel = bl.isAnySmtp ? `<span class="text-blue-600 uppercase font-bold text-[9px]">${bl.handoverDt}</span>` : '<span class="text-rose-600 uppercase font-bold text-[9px]">Pending Handover</span>';
                    const bRem = bl.smtpBRemarks.join(' | ');
                    const isUrgent = /scan|scanning|damage/i.test(bRem);
                    pHtml += `<tr class="border-b border-slate-200 hover:bg-rose-50/30"><td class="px-3 py-1 font-bold text-slate-900 border-r border-slate-300">${bl.blNo} <span class="text-blue-500 text-[8px] uppercase font-bold">(${bl.stats.total} / ${bl.line})</span></td><td class="px-3 py-1 text-slate-600 font-bold border-r border-slate-300 text-[8px] uppercase ${isUrgent ? 'text-rose-700 font-bold' : ''}">${bRem || '-'}</td><td class="px-3 py-1 text-center font-bold text-rose-700 bg-rose-50/50 border-r border-slate-300">${bl.stats.pending}</td><td class="px-3 py-1 text-slate-700 font-bold uppercase border-r border-slate-300">${bl.vessel}</td><td class="px-3 py-1 text-center font-bold uppercase border-r border-slate-300">${statusLabel}</td><td class="px-3 py-1 text-slate-500 text-[9px] font-bold">${bl.pendingRemarks.join(' | ') || 'Awaiting dispatch'}</td></tr>`;
                });
                document.getElementById('pendingDetailRows').innerHTML = pHtml;
                document.getElementById('pendingDetailFooter').innerHTML = `<tr class="bg-rose-50 text-rose-800 font-bold"><td colspan="2" class="px-3 py-1.5 text-right uppercase text-[9px]">Total Pending Units</td><td class="px-3 py-1.5 text-center text-[11px] border-r border-rose-200">${totalPendingUnits}</td><td colspan="3"></td></tr>`;
            }
            lucide.createIcons();
        }

        function processAndRenderReport(consIndex, shouldPopulateFilters = false) {
            // Check karein ki data Shipper se lena hai ya SMTP se
            const dataSource = (consIndex === 24) ? rawSheets.smtp : rawSheets.shipper;
            
            const headers = dataSource[0];
            if (!headers) return;

            const sizeIndex = headers.findIndex(h => String(h).toUpperCase().includes('SIZE'));
            const relevantRows = dataSource.slice(1).filter(row => String(row[consIndex] || '').trim() === selectedShipper);
            
            const blGroups = {};
            const excludedTerms = ['CT3', 'CT4', 'MICT', 'SPRH', 'T2'];
            
            relevantRows.forEach(row => {
                // Column mapping based on data source
                const contNo = (consIndex === 24) ? String(row[2] || '').trim() : String(row[0] || '').trim();
                const blNo = (consIndex === 24) ? String(row[9] || 'N/A').trim() : String(row[2] || 'N/A').trim();
                const sizeValue = String(row[sizeIndex] || '').includes('40') ? 40 : 20;

                if (!blGroups[blNo]) {
                    blGroups[blNo] = { 
                        blNo, stats: { total: 0, s20: 0, s40: 0, railed: 0, pending: 0, r20: 0, r40: 0, p20: 0, p40: 0 },
                        line: '-', vessel: '-', handoverDt: '-', 
                        railedDetails: [], pendingRemarks: [], smtpBRemarks: [], isAnySmtp: false
                    };
                }

                const smtpRow = rawSheets.smtp.find(s => String(s[2] || '').trim() === contNo);
                const webRow = rawSheets.website.find(w => String(w[3] || '').trim() === contNo);
                
                if (smtpRow) {
                    blGroups[blNo].isAnySmtp = true;
                    if (blGroups[blNo].vessel === '-') blGroups[blNo].vessel = smtpRow[5] || '-'; 
                    if (blGroups[blNo].handoverDt === '-') blGroups[blNo].handoverDt = smtpRow[18] || smtpRow[17] || '-'; 
                    if (blGroups[blNo].line === '-') blGroups[blNo].line = smtpRow[23] || '-'; 
                    const cellBVal = String(smtpRow[1] || '').trim();
                    if (cellBVal && !excludedTerms.includes(cellBVal.toUpperCase())) {
                        if (!blGroups[blNo].smtpBRemarks.includes(cellBVal)) blGroups[blNo].smtpBRemarks.push(cellBVal);
                    }
                }

                const railDateRaw = webRow ? webRow[8] : '';
                const railDateStr = String(railDateRaw || '').trim();
                const isRailed = railDateStr && !['-', 'NOT RAILOUT', 'PENDING', '', 'N/A'].includes(railDateStr.toUpperCase());

                if (isRailed) {
                    const trainNo = String(webRow[4] || '').trim();
                    const remark = trainDateRemarksMap[`${trainNo}_${railDateStr}`] || String(webRow[9] || '-').trim();
                    const formattedRailDate = formatToDDMMYY_HHMM(railDateRaw);
                    let existingDetail = blGroups[blNo].railedDetails.find(d => d.train === trainNo && d.date === formattedRailDate);
                    if (existingDetail) existingDetail.count++;
                    else blGroups[blNo].railedDetails.push({ train: trainNo || 'Railed', date: formattedRailDate, remark: remark, count: 1 });
                    if (sizeValue === 20) blGroups[blNo].stats.r20++; else blGroups[blNo].stats.r40++;
                } else {
                    const pRem = (webRow && webRow[9] && webRow[9] !== '-') ? webRow[9] : (smtpRow && smtpRow[22] ? smtpRow[22] : null);
                    if (pRem && !blGroups[blNo].pendingRemarks.includes(pRem)) blGroups[blNo].pendingRemarks.push(pRem);
                    if (sizeValue === 20) blGroups[blNo].stats.p20++; else blGroups[blNo].stats.p40++;
                }
                blGroups[blNo].stats.total++;
                if (sizeValue === 20) blGroups[blNo].stats.s20++; else blGroups[blNo].stats.s40++;
                if (isRailed) blGroups[blNo].stats.railed++; else blGroups[blNo].stats.pending++;
            });

            currentShipperAllGroups = Object.values(blGroups);

            // VESSEL FILTER LOGIC FIX
            if (shouldPopulateFilters) {
                const vesselData = [];
                const seenKeys = new Set();
                currentShipperAllGroups.forEach(g => {
                    if (g.vessel && g.vessel !== '-' && g.vessel !== '') {
                        const displayLabel = `${g.vessel} (${g.handoverDt})`;
                        if (!seenKeys.has(displayLabel)) {
                            vesselData.push({ val: g.vessel, label: displayLabel });
                            seenKeys.add(displayLabel);
                        }
                    }
                });
                vesselData.sort((a, b) => a.label.localeCompare(b.label));
                vesselFilter.innerHTML = '<option value="ALL">All Vessels</option>' + 
                    vesselData.map(v => `<option value="${v.val}">${v.label}</option>`).join('');

                const uniqueBLs = currentShipperAllGroups.map(g => g.blNo).filter(Boolean).sort();
                blFilter.innerHTML = '<option value="ALL">All BLs</option>' + uniqueBLs.map(b => `<option value="${b}">${b}</option>`).join('');
            }
            applyFilters();
        }
	
        function renderShipperList(shippers, consIndex) {
            const listEl = document.getElementById('shipperList');
            const filter = shipperSearch.value.toLowerCase();
            listEl.innerHTML = shippers
                .filter(s => String(s).toLowerCase().includes(filter))
                .map(name => `
                    <button class="shipper-select-btn w-full text-left px-3 py-2 rounded-lg text-[9px] font-bold uppercase transition-all flex items-center justify-between group ${selectedShipper === name ? 'bg-blue-700 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100'}" data-name="${name.replace(/'/g, "\\'")}">
                        <span class="truncate">${name}</span>
                        <i data-lucide="chevron-right" class="w-3 h-3 ${selectedShipper === name ? 'opacity-100' : 'opacity-0'}"></i>
                    </button>
                `).join('');
            lucide.createIcons();
            document.querySelectorAll('.shipper-select-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const name = e.currentTarget.getAttribute('data-name');
                    window.selectShipper(name, consIndex);
                });
            });
        }

        window.selectShipper = function(name, consIndex) {
            selectedShipper = name;
            const activeNameEl = document.getElementById('activeShipperName');
            if(activeNameEl) activeNameEl.innerText = name;
            vesselFilter.value = "ALL";
            blFilter.value = "ALL";
            isInTransitFilterActive = false; // Reset filter on shipper change
            const uniqueShippers = [...new Set(rawSheets.shipper.slice(1).map(row => row[consIndex]))].filter(Boolean).sort();
            renderShipperList(uniqueShippers, consIndex);
            processAndRenderReport(consIndex, true); 
        };

        function processCloudData() {
            trainDateRemarksMap = {};
            if (rawSheets.website && rawSheets.website.length > 1) {
                rawSheets.website.slice(1).forEach(row => {
                    const train = String(row[4] || '').trim(); 
                    const railDateRaw = row[8]; 
                    const railDate = String(railDateRaw || '').trim(); 
                    const remark = String(row[9] || '').trim(); 
                    if (train && railDate && remark && remark !== '-') {
                        trainDateRemarksMap[`${train}_${railDate}`] = remark;
                    }
                });
            }
            if (rawSheets.shipper && rawSheets.shipper.length) initDashboard();
        }

        function initDashboard() {
            const emptyState = document.getElementById('emptyState');
            const reportContainer = document.getElementById('reportContainer');
            emptyState.classList.add('hidden');
            reportContainer.classList.remove('hidden');
            if(document.getElementById('downloadBtn')) document.getElementById('downloadBtn').classList.remove('hidden');
            if(document.getElementById('resetBtn')) document.getElementById('resetBtn').classList.remove('hidden');

            const headers = rawSheets.shipper[0];
            if(!headers) return;
            const consIndex = headers.findIndex(h => String(h).toUpperCase().includes('CONSIGNEE'));
            renderShipperList([...new Set(rawSheets.shipper.slice(1).map(row => row[consIndex]))].filter(Boolean).sort(), consIndex);
            
            if (!selectedShipper) {
                 const firstShipper = [...new Set(rawSheets.shipper.slice(1).map(row => row[consIndex]))].filter(Boolean).sort()[0];
                 if(firstShipper) window.selectShipper(firstShipper, consIndex);
            } else {
                 processAndRenderReport(consIndex, true);
            }
        }

        async function loadFromCloud() {
            if (!isCloudEnabled || !auth.currentUser) return;
            cloudLabel.innerText = "Loading...";
            refreshIcon.classList.add('animate-spin');
            try {
                const metaRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_meta', 'latest');
                const metaSnap = await getDoc(metaRef);
                if (metaSnap.exists()) {
                    const { chunkCount } = metaSnap.data();
                    if (chunkCount === 0) {
                        cloudLabel.innerText = "Online";
                        refreshIcon.classList.remove('animate-spin');
                        return;
                    }
                    let fullStr = "";
                    for (let i = 0; i < chunkCount; i++) {
                        const chunkRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_chunks', `chunk_${i}`);
                        const chunkSnap = await getDoc(chunkRef);
                        if (chunkSnap.exists()) fullStr += chunkSnap.data().data;
                    }
                    if (fullStr) {
                        rawSheets = JSON.parse(fullStr);
                        processCloudData();
                    }
                }
                cloudLabel.innerText = "Online";
            } catch (e) { 
                console.error("Cloud Load Error:", e); 
                cloudLabel.innerText = "Load Error";
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }

        async function saveToCloud() {
            if (!isCloudEnabled || !auth.currentUser) return;
            cloudLabel.innerText = "Saving...";
            cloudIndicator.classList.add('animate-pulse');
            try {
                const str = JSON.stringify(rawSheets);
                const chunkSize = 800000; 
                const chunkCount = Math.ceil(str.length / chunkSize);
                for (let i = 0; i < chunkCount; i++) {
                    const chunk = str.substring(i * chunkSize, (i + 1) * chunkSize);
                    const chunkRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_chunks', `chunk_${i}`);
                    await setDoc(chunkRef, { data: chunk });
                }
                const metaRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_meta', 'latest');
                await setDoc(metaRef, { chunkCount, updatedAt: new Date().toISOString() });
                cloudLabel.innerText = "Online";
                cloudIndicator.classList.remove('animate-pulse');
            } catch (e) {
                console.error("Save Error:", e);
                cloudLabel.innerText = "Save Error";
            }
        }


        // ------------------------------------------
        // 3. LOGIN & MODAL CONTROLS
        // ------------------------------------------
        const handleLogin = () => {
            const passwordField = document.getElementById('loginPassword');
            const input = passwordField.value;
            const error = document.getElementById('loginError');
            if (input === "16111980") {
                sessionStorage.setItem('isLoggedIn', 'true');
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    lucide.createIcons();
                }, 500);
            } else {
                error.classList.remove('hidden');
                passwordField.value = '';
                passwordField.focus();
            }
        };

        // ------------------------------------------
        // 4. WEBSITE RAKE & ARRIVAL LOGIC
        // ------------------------------------------
        function populateRakeList() {
            if (!rawSheets.website || rawSheets.website.length <= 1) return;
            const uniqueRakes = new Map();
            rawSheets.website.slice(1).forEach(row => {
                const rake = String(row[4] || '').trim();
                const remark = String(row[9] || '').toUpperCase();
                // Filter: Only show rakes where Remark contains "RAILOUT FROM"
                if (rake && rake !== "-" && remark.includes("RAILOUT FROM")) {
                    uniqueRakes.set(rake, row[8]); 
                }
            });

            rakeSelect.innerHTML = '<option value="">Select Rake No</option>';
            [...uniqueRakes.keys()].sort().forEach(rake => {
                const option = document.createElement('option');
                option.value = rake;
                option.textContent = rake;
                option.dataset.raildate = uniqueRakes.get(rake);
                rakeSelect.appendChild(option);
            });
        }

        rakeSelect.addEventListener('change', () => {
            const selected = rakeSelect.selectedOptions[0];
            const rakeVal = rakeSelect.value;
            const rawVal = selected ? (selected.dataset.raildate || '') : '';
            railDateDisplay.value = rawVal ? formatToDDMMYY_HHMM(rawVal) : '';
            
            // Auto-load existing remark for this rake to show in box
            if (rakeVal) {
                const matchingRow = rawSheets.website.find(row => 
                    String(row[4]).trim() === rakeVal && 
                    String(row[9] || '').toUpperCase().includes("RAILOUT FROM")
                );
                customRemarksInput.value = matchingRow ? matchingRow[9] : '';
            } else {
                customRemarksInput.value = '';
            }
        });

        updateArrivedBtn.addEventListener('click', () => {
            const rake = rakeSelect.value;
            const arrivedDate = arrivedDateInput.value.trim();
            if (!rake) { 
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">Please select a Rake No first.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
                return; 
            }
            if (!arrivedDate) { 
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">Please enter Arrival Date.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
                return; 
            }

            let updateCount = 0;
            rawSheets.website.slice(1).forEach((row) => {
                const currentRemark = String(row[9] || '').toUpperCase();
                if (String(row[4]).trim() === rake && currentRemark.includes("RAILOUT FROM")) {
                    row[9] = `TRAIN ARRIVED ON ${arrivedDate}`;
                    updateCount++;
                }
            });

            if (updateCount > 0) {
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">Success! ${updateCount} containers updated for Rake ${rake}.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
                saveToCloud();
                processCloudData();
                window.viewSheetData('website'); 
                populateRakeList(); 
                arrivedDateInput.value = '';
            } else {
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">No matching containers found.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
            }
        });

        updateCustomRemarksBtn.addEventListener('click', () => {
            const rake = rakeSelect.value;
            const newRemark = customRemarksInput.value.trim();
            if (!rake) { 
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">Please select a Rake No first.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
                return; 
            }
            if (!newRemark) { 
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">Please enter new Remarks.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
                return; 
            }

            let updateCount = 0;
            rawSheets.website.slice(1).forEach((row) => {
                const currentRemark = String(row[9] || '').toUpperCase();
                // Logic: Only update if RAKE_NO matches AND remark contains "RAILOUT FROM"
                if (String(row[4]).trim() === rake && currentRemark.includes("RAILOUT FROM")) {
                    row[9] = newRemark;
                    updateCount++;
                }
            });

            if (updateCount > 0) {
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-amber-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">Remarks updated for ${updateCount} containers in Rake ${rake}.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
                saveToCloud();
                processCloudData();
                window.viewSheetData('website'); 
            } else {
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">No matching 'RAILOUT' containers found for this rake.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
            }
        });

        // ------------------------------------------
        // 5. UPDATE MODAL VIEW LOGIC & DELETE ROW
        // ------------------------------------------
        window.deleteRow = (index) => {
            if (!currentSheetInView) return;
            if (index === 0) return; // Prevent deleting header

            if (confirm(`Are you sure you want to delete this row from ${currentSheetInView.toUpperCase()}?`)) {
                rawSheets[currentSheetInView].splice(index, 1);
                window.viewSheetData(currentSheetInView);
                saveToCloud();
                processCloudData();
                
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000]">Row deleted.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 2000);
            }
        };

        document.getElementById('deleteAllRowsBtn').addEventListener('click', () => {
            if (!currentSheetInView) {
                alert("Please select a sheet first.");
                return;
            }
            if (confirm(`DANGER: Are you sure you want to delete ALL data entries from ${currentSheetInView.toUpperCase()}? Header row will be kept.`)) {
                if (rawSheets[currentSheetInView] && rawSheets[currentSheetInView].length > 0) {
                    const header = rawSheets[currentSheetInView][0];
                    rawSheets[currentSheetInView] = [header];
                    window.viewSheetData(currentSheetInView);
                    saveToCloud();
                    processCloudData();
                    
                    const box = document.createElement('div');
                    box.innerHTML = `<div class="fixed top-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[100000]">All data rows in ${currentSheetInView} deleted.</div>`;
                    document.body.appendChild(box);
                    setTimeout(() => box.remove(), 3000);
                }
            }
        });

        window.viewSheetData = (sheetName) => {
            currentSheetInView = sheetName;
            const container = document.getElementById('sheetDataContainer');
            const data = rawSheets[sheetName];
            
            // Manage Tab-specific tool visibility
            const webSection = document.getElementById('websiteUpdateSection');
            const smtpSection = document.getElementById('smtpUpdateSection');
            const shipperSection = document.getElementById('shipperUpdateSection');

            if (sheetName === 'website') {
                webSection.classList.remove('hidden');
                webSection.classList.add('flex');
                smtpSection.classList.add('hidden');
                smtpSection.classList.remove('flex');
                shipperSection.classList.add('hidden');
                shipperSection.classList.remove('flex');
                populateRakeList();
            } else if (sheetName === 'smtp') {
                smtpSection.classList.remove('hidden');
                smtpSection.classList.add('flex');
                webSection.classList.add('hidden');
                webSection.classList.remove('flex');
                shipperSection.classList.add('hidden');
                shipperSection.classList.remove('flex');
            } else if (sheetName === 'shipper') {
                shipperSection.classList.remove('hidden');
                shipperSection.classList.add('flex');
                webSection.classList.add('hidden');
                webSection.classList.remove('flex');
                smtpSection.classList.add('hidden');
                smtpSection.classList.remove('flex');
            } else {
                webSection.classList.add('hidden');
                webSection.classList.remove('flex');
                smtpSection.classList.add('hidden');
                smtpSection.classList.remove('flex');
                shipperSection.classList.add('hidden');
                shipperSection.classList.remove('flex');
            }

            document.querySelectorAll('.sheet-tab-btn').forEach(btn => {
                if (btn.getAttribute('data-sheet') === sheetName) {
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                    btn.classList.remove('bg-white', 'text-slate-700');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                    btn.classList.add('bg-white', 'text-slate-700');
                }
            });

            if (!data || data.length === 0) {
                container.innerHTML = `<div class="p-10 text-center font-bold text-slate-400 uppercase text-[10px]">No data found in ${sheetName}</div>`;
                return;
            }

            let html = `<table id="editableTable" class="min-w-full text-[9px] uppercase">`;
            data.forEach((row, rowIndex) => {
                const isHeader = rowIndex === 0;
                const rowClass = isHeader ? 'bg-slate-800 text-white font-bold sticky top-0' : 'border-b border-slate-200 hover:bg-slate-50';
                html += `<tr class="${rowClass}">`;
                
                // Add Delete Action Column
                if (isHeader) {
                    html += `<th class="px-2 py-1.5 border-r border-slate-200 w-10 text-center">ACTION</th>`;
                } else {
                    html += `<td class="px-2 py-1.5 border-r border-slate-200 text-center">
                                <button onclick="window.deleteRow(${rowIndex})" class="delete-row-btn text-rose-500 transition-all">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                </button>
                             </td>`;
                }

                const maxCols = Math.max(...data.map(r => r.length));
                for(let colIndex = 0; colIndex < maxCols; colIndex++) {
                    const content = row[colIndex] !== undefined && row[colIndex] !== null ? row[colIndex] : '';
                    html += `<td class="px-2 py-1.5 border-r border-slate-200 truncate max-w-[200px] ${!isHeader ? 'editable-cell' : ''}" 
                                ${!isHeader ? 'contenteditable="true"' : ''} 
                                data-row="${rowIndex}" data-col="${colIndex}">${content}</td>`;
                }
                html += `</tr>`;
            });
            html += `</table>`;
            container.innerHTML = html;
            lucide.createIcons();
        };

        // ------------------------------------------
        // 6. MAIN APP INITIALIZATION & EVENTS
        // ------------------------------------------
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { await signInAnonymously(auth); }
                } else { await signInAnonymously(auth); }
            } catch (error) {
                cloudLabel.innerText = "Auth Error";
                cloudIndicator.className = "w-2 h-2 rounded-full bg-red-500";
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                cloudIndicator.className = "w-2 h-2 rounded-full bg-emerald-500";
                cloudLabel.innerText = "Online";
                loadFromCloud();
                const currentTimeEl = document.getElementById('currentTime');
                if (currentTimeEl) currentTimeEl.innerText = formatToDDMMYYYY(new Date());
            }
        });

        authBtn.addEventListener('click', handleLogin);
        document.getElementById('loginPassword').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

        document.getElementById('tabShipper').addEventListener('click', () => window.viewSheetData('shipper'));
        document.getElementById('tabSmtp').addEventListener('click', () => window.viewSheetData('smtp'));
        document.getElementById('tabWebsite').addEventListener('click', () => window.viewSheetData('website'));

        openUpdateModalBtn.addEventListener('click', () => {
            document.getElementById('updateModal').classList.remove('hidden');
            lucide.createIcons();
        });

        closeModalBtn.addEventListener('click', window.hideModal);
        closeModalBtnFooter.addEventListener('click', window.hideModal);

        saveLocalChangesBtn.addEventListener('click', () => {
            if (!currentSheetInView) return;
            const cells = document.querySelectorAll('#editableTable .editable-cell');
            cells.forEach(cell => {
                const r = parseInt(cell.getAttribute('data-row'));
                const c = parseInt(cell.getAttribute('data-col'));
                if (!rawSheets[currentSheetInView][r]) rawSheets[currentSheetInView][r] = [];
                rawSheets[currentSheetInView][r][c] = cell.innerText.trim();
            });
            saveToCloud(); processCloudData();
            saveLocalChangesBtn.innerHTML = 'CHANGES SAVED!';
            setTimeout(() => { saveLocalChangesBtn.innerHTML = 'Save Changes'; }, 2000);
        });

        const addSmtpBtn = document.getElementById('addSmtpBtn');
        addSmtpBtn.addEventListener('click', () => {
            if (!rawSheets.smtp || rawSheets.smtp.length <= 1) { 
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">SMTP data is empty.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 3000);
                return; 
            }
            if (!rawSheets.website || rawSheets.website.length === 0) rawSheets.website = [["UID", "SR_NO", "BILL_NO", "CONTAINER_NO", "RAKE_NO", "STACK", "SOURCE", "DESTINATION", "RAILING_DATE", "REMARKS"]];
            const smtpHeaders = rawSheets.smtp[0];
            const sContIdx = smtpHeaders.findIndex(h => String(h).toUpperCase().includes('CONT'));
            const sBlIdx = smtpHeaders.findIndex(h => String(h).toUpperCase().includes('BL'));
            const sTpIdx = smtpHeaders.findIndex(h => String(h).toUpperCase().includes('TP_SUBMITTING')) !== -1 ? smtpHeaders.findIndex(h => String(h).toUpperCase().includes('TP_SUBMITTING')) : 18;

            let addedCount = 0;
            rawSheets.smtp.slice(1).forEach(sRow => {
                const contNo = String(sRow[sContIdx] || '').trim();
                if (!contNo) return;
                const alreadyExists = rawSheets.website.some(w => String(w[3] || '').trim() === contNo);
                if (!alreadyExists) {
                    const blNo = String(sRow[sBlIdx] || '').trim();
                    const tpDate = formatToDDMMYYYY(sRow[sTpIdx]);
                    rawSheets.website.push([103, rawSheets.website.length, blNo, contNo, "-", "Lower", "Mundra", "KILARAIPUR", "Pending", `CONTAINER HANDOVER TO HTPL ON ${tpDate}`]);
                    addedCount++;
                }
            });
            window.viewSheetData('website');
            const box = document.createElement('div');
            box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">${addedCount} containers added to Website list.</div>`;
            document.body.appendChild(box);
            setTimeout(() => box.remove(), 3000);
            saveToCloud(); processCloudData();
        });

        // Temporary storage for excel processing
        let pendingExcelData = null;
        let pendingRakeNo = null;

        const executeExcelUpdate = (rakeNo, railDateVal, jsonData) => {
            let matchCount = 0;
            jsonData.slice(10).forEach(exRow => {
                const contNo = String(exRow[2] || '').trim(); 
                const rawExcelDate = railDateVal || exRow[33]; 
                const railDateFormatted = formatToDDMMYY_HHMM(rawExcelDate); 
                
                if (contNo && rawSheets.website) {
                    const webMatchIndex = rawSheets.website.findIndex(w => String(w[3] || '').trim() === contNo);
                    if (webMatchIndex !== -1) {
                        let dateObj = null;
                        const numVal = parseFloat(rawExcelDate);
                        
                        if (!isNaN(numVal) && isFinite(rawExcelDate) && numVal > 40000) {
                            dateObj = new Date(Math.round((numVal - 25569) * 86400 * 1000));
                        } else if (rawExcelDate) {
                            const parts = String(rawExcelDate).split(/[-/ :]/);
                            if (parts.length >= 3) {
                                let d = parseInt(parts[0]);
                                let m = parseInt(parts[1]) - 1;
                                let y = parseInt(parts[2]);
                                if (y < 100) y += 2000;
                                let hh = parseInt(parts[3] || 0);
                                let mm = parseInt(parts[4] || 0);
                                dateObj = new Date(y, m, d, hh, mm);
                            } else {
                                dateObj = new Date(rawExcelDate);
                            }
                        }

                        let etaString = '';
                        if (dateObj && !isNaN(dateObj.getTime())) {
                            const newDate = new Date(dateObj.getTime());
                            newDate.setDate(newDate.getDate() + 4);
                            const d = String(newDate.getDate()).padStart(2, '0');
                            const m = String(newDate.getMonth() + 1).padStart(2, '0');
                            const y = newDate.getFullYear();
                            etaString = ` ETA ${d}-${m}-${y} 00:00`;
                        }

                        rawSheets.website[webMatchIndex][4] = rakeNo;
                        rawSheets.website[webMatchIndex][8] = railDateFormatted;
                        rawSheets.website[webMatchIndex][9] = `RAILOUT FROM MUNDRA ON ${railDateFormatted}${etaString}`;
                        matchCount++;
                    }
                }
            });
            window.viewSheetData('website');
            const box = document.createElement('div');
            box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">${matchCount} containers updated successfully.</div>`;
            document.body.appendChild(box);
            setTimeout(() => box.remove(), 3000);
            saveToCloud(); processCloudData();
        };

        const websiteExcelInput = document.getElementById('websiteExcelInput');
        websiteExcelInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rakeNo = ws['H7'] ? String(ws['H7'].v).trim() : '';
                const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                
                if (jsonData.length < 11) {
                    const box = document.createElement('div');
                    box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000]">File format invalid (too few rows).</div>`;
                    document.body.appendChild(box);
                    setTimeout(() => box.remove(), 3000);
                    return;
                }

                const ah11Value = (jsonData[10] && jsonData[10][33]) ? String(jsonData[10][33]).trim() : "";
                
                if (ah11Value === "") {
                    pendingExcelData = jsonData;
                    pendingRakeNo = rakeNo;
                    document.getElementById('manualDateModal').classList.remove('hidden');
                    document.getElementById('manualRailDateInput').focus();
                    lucide.createIcons();
                } else {
                    executeExcelUpdate(rakeNo, null, jsonData);
                }
            };
            reader.readAsBinaryString(file);
            e.target.value = '';
        });

        // ------------------------------------------
        // SHIPPER EXCEL IMPORT LOGIC (Strict Cell Reference A, B, C, D)
        // ------------------------------------------
        const shipperExcelInput = document.getElementById('shipperExcelInput');
        shipperExcelInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                
                if (jsonData.length < 2) return;

                const contIdx = 0;
                const sizeIdx = 1;
                const blIdx = 2;
                const consIdx = 3;

                const internalHeaders = rawSheets.shipper[0];
                if (!internalHeaders) {
                    alert("SHIPPER sheet structure is missing headers.");
                    return;
                }

                const internalContIdx = 0; 
                const internalSizeIdx = internalHeaders.findIndex(h => /SIZE/i.test(String(h)));
                const internalBlIdx = internalHeaders.findIndex(h => /BL/i.test(String(h)));
                const internalConsIdx = internalHeaders.findIndex(h => /CONSIGNEE/i.test(String(h)));

                let addedCount = 0;
                let skipCount = 0;

                jsonData.slice(1).forEach(exRow => {
                    const contNo = String(exRow[contIdx] || '').trim();
                    if (!contNo) return;

                    const alreadyExists = rawSheets.shipper.some(s => String(s[internalContIdx] || '').trim() === contNo);
                    if (!alreadyExists) {
                        let newRow = new Array(internalHeaders.length).fill("");
                        newRow[internalContIdx] = contNo;
                        if (internalBlIdx !== -1) newRow[internalBlIdx] = String(exRow[blIdx] || '').trim();
                        if (internalSizeIdx !== -1) newRow[internalSizeIdx] = String(exRow[sizeIdx] || '').trim();
                        if (internalConsIdx !== -1) newRow[internalConsIdx] = String(exRow[consIdx] || '').trim();
                        
                        rawSheets.shipper.push(newRow);
                        addedCount++;
                    } else {
                        skipCount++;
                    }
                });

                window.viewSheetData('shipper');
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">SHIPPER Import Complete: ${addedCount} added, ${skipCount} duplicates skipped.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 4000);
                saveToCloud();
                processCloudData();
            };
            reader.readAsBinaryString(file);
            e.target.value = '';
        });

        // ------------------------------------------
        // SMTP EXCEL IMPORT LOGIC
        // ------------------------------------------
        const smtpExcelInput = document.getElementById('smtpExcelInput');
        smtpExcelInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                
                if (jsonData.length < 2) return;

                const smtpHeaders = rawSheets.smtp[0];
                const sContIdx = smtpHeaders ? smtpHeaders.findIndex(h => String(h).toUpperCase().includes('CONT')) : 2;

                let addedCount = 0;
                let skipCount = 0;

                jsonData.slice(1).forEach(exRow => {
                    const contNo = String(exRow[sContIdx] || '').trim();
                    // Cell L is index 11 (12th column: A=0, B=1, ..., L=11)
                    const cellLValue = String(exRow[11] || '').toUpperCase(); 

                    if (contNo && (cellLValue.includes("KILARAIPUR") || cellLValue.includes("LUDHIANA"))) {
                        const alreadyExists = rawSheets.smtp.some(s => String(s[sContIdx] || '').trim() === contNo);
                        
                        if (!alreadyExists) {
                            rawSheets.smtp.push(exRow);
                            addedCount++;
                        } else {
                            skipCount++;
                        }
                    }
                });

                window.viewSheetData('smtp');
                const box = document.createElement('div');
                box.innerHTML = `<div class="fixed top-10 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-6 py-3 rounded-xl shadow-2xl font-bold uppercase text-[10px] z-[10000] animate-bounce">SMTP Update Complete: ${addedCount} added, ${skipCount} duplicates skipped.</div>`;
                document.body.appendChild(box);
                setTimeout(() => box.remove(), 4000);
                saveToCloud();
                processCloudData();
            };
            reader.readAsBinaryString(file);
            e.target.value = '';
        });

        // Manual Date Modal Events
        document.getElementById('submitManualDateBtn').addEventListener('click', () => {
            const dateVal = document.getElementById('manualRailDateInput').value.trim();
            if (!dateVal) {
                document.getElementById('manualRailDateInput').classList.add('ring-2', 'ring-rose-500');
                return;
            }
            document.getElementById('manualRailDateInput').classList.remove('ring-2', 'ring-rose-500');
            document.getElementById('manualDateModal').classList.add('hidden');
            executeExcelUpdate(pendingRakeNo, dateVal, pendingExcelData);
            document.getElementById('manualRailDateInput').value = '';
        });

        document.getElementById('cancelManualDateBtn').addEventListener('click', () => {
            document.getElementById('manualDateModal').classList.add('hidden');
            pendingExcelData = null;
            pendingRakeNo = null;
        });

        refreshBtn.addEventListener('click', () => { loadFromCloud(); });
        saveImageBtn.addEventListener('click', () => {
            if (!selectedShipper || !rawSheets.shipper.length) return;
            const area = document.getElementById('reportContainer');
            const btn = document.getElementById('saveImageBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> SAVING...';
            lucide.createIcons();
            setTimeout(() => {
                html2canvas(area, {
                    backgroundColor: "#e2e8f0", scale: 3, useCORS: true, allowTaint: true,
                    onclone: (clonedDoc) => {
                        const clonedArea = clonedDoc.getElementById('reportContainer');
                        clonedArea.style.display = 'block';
                        clonedArea.style.padding = '40px';
                        const noPrints = clonedDoc.querySelectorAll('.no-print');
                        noPrints.forEach(el => { if (el.id !== 'overallStats') el.style.display = 'none'; });
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `LOGISTICS_REPORT_${selectedShipper}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                    btn.innerHTML = originalHTML;
                    lucide.createIcons();
                });
            }, 800);
        });

        vesselFilter.addEventListener('change', applyFilters);
        blFilter.addEventListener('change', applyFilters);
        shipperSearch.addEventListener('input', () => {
            const headers = rawSheets.shipper[0];
            if(!headers) return;
            const consIndex = headers.findIndex(h => String(h).toUpperCase().includes('CONSIGNEE'));
            renderShipperList([...new Set(rawSheets.shipper.slice(1).map(row => row[consIndex]))].filter(Boolean).sort(), consIndex);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const findSheet = (name) => wb.SheetNames.find(s => s.toUpperCase() === name.toUpperCase());
                rawSheets = {
                    shipper: XLSX.utils.sheet_to_json(wb.Sheets[findSheet('SHIPPER')], {header: 1}),
                    smtp: XLSX.utils.sheet_to_json(wb.Sheets[findSheet('SMTP')], {header: 1}),
                    website: XLSX.utils.sheet_to_json(wb.Sheets[findSheet('WEBSITE')], {header: 1})
                };
                saveToCloud(); processCloudData();
            };
            reader.readAsBinaryString(file);
        });
// Yaha se paste karein (Line 809 ke paas)

// --- NEW SMTP SEARCH & REPORT LOGIC ---
document.getElementById('smtpBlSearch').addEventListener('input', (e) => {
    const searchVal = e.target.value.trim().toUpperCase();
    const resultBox = document.getElementById('smtpConsigneeBox');
    const nameDisplay = document.getElementById('smtpConsigneeName');

    if (searchVal.length >= 4 && rawSheets.smtp && rawSheets.smtp.length > 1) {
        const match = rawSheets.smtp.find(row => String(row[9] || '').toUpperCase().includes(searchVal));
        if (match && match[24]) {
            const foundConsignee = String(match[24]).trim();
            nameDisplay.innerText = foundConsignee;
            resultBox.classList.remove('hidden');

            resultBox.onclick = () => {
                selectedShipper = foundConsignee; 
                document.getElementById('activeShipperName').innerText = foundConsignee + " (BL: " + searchVal + ")";
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('reportContainer').classList.remove('hidden');

                // Generate SMTP report (24 is index for Consignee)
                processAndRenderReport(24, true); 

                // LOCK to searched BL
                setTimeout(() => {
                    blFilter.value = searchVal;
                    applyFilters();
                }, 100);
                
                e.target.value = '';
                resultBox.classList.add('hidden');
            };
        } else {
            resultBox.classList.remove('hidden');
            nameDisplay.innerText = "No BL Found in SMTP";
        }
    } else {
        resultBox.classList.add('hidden');
    }
});

// Iske baad aapka purana initAuth(); aayega
initAuth();

        initAuth();
    </script>
</body>
</html>
